# SmoothTask — план задач

## Легенда статусов

- [ ] TODO       — задача ещё не делалась
- [~] IN PROGRESS — начата, но не завершена
- [x] DONE       — реализовано и покрыто тестами
- [!] BLOCKED    — есть блокер, нужна дополнительная информация

---

## 1. Ближайшие шаги (Next Up)

- [x] ST-027: Unit-тесты для tune_policy модуля
  - Тип: Python / trainer / tests
  - Критерии готовности:
    - [x] Создан тестовый файл test_tune_policy.py;
    - [x] Тесты проверяют сигнатуру функции;
    - [x] Тесты проверяют обработку NotImplementedError;
    - [x] Тесты проверяют обработку несуществующей и пустой БД;
    - [x] Все тесты проходят (4 теста).
  - Примечания: добавлены 4 unit-теста для модуля tune_policy. Тесты проверяют сигнатуру функции, обработку NotImplementedError (пока функция не реализована), обработку несуществующей и пустой БД. Добавлена зависимость pyyaml в pyproject.toml. Все тесты проходят успешно.

## 2. Бэклог

- [x] ST-010: Actuator: применение приоритетов через nice/ionice/cgroups
  - Тип: Rust / core / actuator
  - Критерии готовности:
    - [x] Применение nice через setpriority;
    - [x] Применение ionice через ioprio_set;
    - [x] Управление cgroups v2 (cpu.weight через прямое управление файловой системой);
    - [x] Гистерезис для предотвращения частых изменений;
    - [x] Unit-тесты на применение приоритетов (13 тестов, покрывают гистерезис, логику планирования и работу с cgroups).
  - Примечания: реализованы функции apply_nice() и apply_ionice() через libc, добавлен HysteresisTracker с настраиваемыми параметрами (min_time_between_changes, min_class_difference), функция apply_priority_adjustments() применяет изменения с учётом гистерезиса. Полностью реализовано управление cgroups v2 через функции read_process_cgroup(), get_or_create_app_cgroup(), set_cpu_weight(), move_process_to_cgroup() и apply_cgroup(). Добавлены 13 unit-тестов, покрывающих все аспекты работы Actuator.


## 3. Готово (Done)

- [x] ST-000: Валидация конфигурации при загрузке
  - Примечания: покрыто юнит-тестом загрузки `Config::load`.
- [x] ST-003: Сбор пользовательского ввода (evdev) для user_active/idle
  - Примечания: добавлен `InputActivityTracker` с юнит-тестами, считает `user_active` и `time_since_last_input_ms` без зависимости от реального `/dev/input`.
- [x] ST-006: Классы приоритетов и маппинг на nice/ionice/cgroup
  - Примечания: реализованы все классы приоритетов с маппингом согласно POLICY.md, добавлены 10 unit-тестов, поддержка serde для сериализации.
- [x] ST-005-1: Каркас аудио метрик (структуры, трейт, статический бекенд)
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - Структуры `AudioMetrics`, `AudioClientInfo`, `XrunInfo`;
    - Трейт `AudioIntrospector` с методами `audio_metrics()` и `clients()`;
    - `StaticAudioIntrospector` для тестов;
    - Unit-тесты на все компоненты (8 тестов).
  - Примечания: реализованы нормализованные структуры данных для XRUN событий и аудио-клиентов, трейт для абстракции бекендов, статический бекенд для тестов. Добавлены 8 unit-тестов, покрывающих основные сценарии. API готово для интеграции реальных PipeWire/PulseAudio адаптеров.
- [x] ST-004: Каркас WindowIntrospector и выбор фокусного окна
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - Нормализованные структуры `WindowInfo`/`WindowState`;
    - Каркас интерфейса `WindowIntrospector` с базовым бекендом-заглушкой;
    - Юнит-тесты на выбор активного окна и корректность confidence.
  - Примечания: реализованы структуры и статический бекенд; выбор активного окна учитывает `pid_confidence`; добавлены функции `get_window_info_by_pid()` и `build_pid_to_window_map()`; покрыто 12 unit-тестами. Реальный X11/Wayland адаптер - отдельная задача из бэклога.
- [x] ST-007: Process Grouper для группировки процессов в AppGroup
  - Тип: Rust / core / classify
  - Критерии готовности:
    - Модуль `classify::grouper` с функцией `group_processes()`;
    - Группировка по cgroup_path (с нормализацией);
    - Группировка по дереву процессов (root и потомки);
    - Определение root_pid для каждой группы;
    - Агрегация метрик группы (CPU, IO, память, GUI, теги);
    - Unit-тесты на все сценарии группировки (8 тестов).
  - Примечания: реализован алгоритм группировки процессов в AppGroup с поддержкой группировки по cgroup и дереву процессов. Добавлены 8 unit-тестов, покрывающих пустой список, одиночный процесс, дерево процессов, группировку по cgroup, множественные группы, нормализацию cgroup, агрегацию метрик и независимые деревья.
- [x] ST-008-1: Структуры данных для паттернов и загрузка из YAML
  - Тип: Rust / core / classify
  - Критерии готовности:
    - Структуры для представления паттернов приложений (AppPattern, PatternCategory);
    - Загрузка паттернов из YAML файлов в директории patterns;
    - Поддержка сопоставления по exe_patterns, desktop_patterns, cgroup_patterns;
    - Unit-тесты на загрузку и парсинг паттернов.
  - Примечания: реализованы структуры PatternDatabase, AppPattern, PatternFile с загрузкой из YAML. Поддержка простых wildcard паттернов (*, ?). Добавлены 7 unit-тестов на загрузку и сопоставление паттернов.
- [x] ST-008-2: Классификатор процессов по паттернам
  - Тип: Rust / core / classify
  - Критерии готовности:
    - Функция классификации процессов и AppGroup по паттернам;
    - Заполнение process_type и tags в ProcessRecord;
    - Агрегация тегов для AppGroupRecord;
    - Unit-тесты на классификацию различных процессов.
  - Примечания: реализованы функции classify_process(), classify_app_group() и classify_all() для классификации процессов и групп по паттернам. Заполняются process_type и tags. Добавлены 4 unit-теста на классификацию (всего 11 тестов в модуле).
- [x] ST-009: Policy Engine: применение жёстких и семантических правил
  - Тип: Rust / core / policy
  - Критерии готовности:
    - Реализация жёстких правил (guardrails): защита системных процессов, RT-приоритеты, аудио, batch-группы;
    - Реализация семантических правил: фокусный GUI, активный терминал, updater/indexer, noisy neighbour;
    - Unit-тесты для всех правил (7 тестов);
    - API `PolicyEngine::evaluate_snapshot()` готово для использования в главном цикле демона.
  - Примечания: реализованы все основные правила согласно POLICY.md. Добавлены 7 unit-тестов, покрывающих все сценарии правил. Policy Engine определяет приоритеты для AppGroup на основе метрик и контекста.

- [x] ST-006: Классы приоритетов и маппинг на nice/ionice/cgroup
  - Примечания: реализованы все классы приоритетов с маппингом согласно POLICY.md, добавлены 10 unit-тестов, поддержка serde для сериализации.

- [x] ST-001: Глобальные метрики /proc + PSI
  - Примечания: реализованы парсеры и фиктивный /proc в тестах.

- [x] ST-002: Экспорт снапшотов в SQLite и чтение в трейнере
  - Примечания: реализованы тесты для записи (Rust) и чтения (Python), исправлена ошибка с количеством колонок в INSERT-запросе.
- [x] ST-010-2: Полная реализация управления cgroups v2
  - Тип: Rust / core / actuator
  - Критерии готовности:
    - [x] Определение cgroup процесса из /proc/[pid]/cgroup;
    - [x] Создание/использование cgroups для AppGroup (через прямое управление файловой системой);
    - [x] Установка cpu.weight через запись в /sys/fs/cgroup/.../cpu.weight;
    - [x] Перемещение процессов в нужные cgroups через cgroup.procs;
    - [x] Unit-тесты на парсинг cgroup и создание путей (4 теста).
  - Примечания: реализованы функции read_process_cgroup(), get_or_create_app_cgroup(), set_cpu_weight(), move_process_to_cgroup() и apply_cgroup(). Cgroups создаются под /sys/fs/cgroup/smoothtask/app-{app_group_id}. Добавлены 4 unit-теста, покрывающих парсинг cgroup v2 формата, обработку несуществующих PID, определение корня cgroup и создание путей для AppGroup. Реализация использует прямое управление файловой системой вместо cgroups-rs API, что является стандартным подходом в Linux.
- [x] ST-011-1: Сбор метрик процессов из /proc (легкие метрики)
  - Тип: Rust / core / metrics
  - Примечания: реализован модуль `metrics::process` с функцией `collect_process_metrics()`, использующей библиотеку `procfs` для чтения метрик процессов. Добавлены вспомогательные функции для чтения cgroup_path, systemd_unit, UID/GID и переменных окружения. Добавлены 6 unit-тестов, покрывающих парсинг cgroup, извлечение systemd unit, чтение переменных окружения и обработку ошибок.
- [x] ST-010-1: Планировщик изменений Actuator (nice/ionice без системных вызовов)
  - Тип: Rust / core / actuator
  - Примечания: добавлен планировщик `plan_priority_changes`, формирующий диффы по nice/ionice на основе PolicyResult; покрыт 3 юнит-тестами.
- [x] ST-005-2a: Парсер `pw-dump` → AudioClientInfo
  - Тип: Rust / core / metrics
  - Примечания: добавлен модуль `metrics::audio_pipewire` с парсером `parse_pw_dump_clients`, 3 юнит-теста.
- [x] ST-012: Построение фич для тренера (`build_feature_matrix`)
  - Тип: Python / trainer
  - Примечания: реализована трансформация с дефолтами и cat-индексами, добавлены тесты.
- [x] ST-013: Unit-тесты для train_ranker модуля
  - Тип: Python / trainer
  - Примечания: добавлены 4 unit-теста в `tests/test_train_ranker.py`, покрывающие основные сценарии использования `train_ranker`. Тесты проверяют сохранение моделей, обработку ошибок и корректность параметров обученной модели.
- [x] ST-014: Дефолты кат-фич и тегов в build_feature_matrix
  - Тип: Python / trainer / tests
  - Примечания: отсутствующие теги нормализуются в `unknown`, категориальные фичи получают консистентные дефолты.
- [x] ST-015: Доп. проверки build_feature_matrix (trainer)
  - Тип: Python / trainer / tests
  - Примечания: добавлены проверки на пустой DataFrame и порядок cat_feature_indices, все тесты проходят.
- [x] ST-016: Реализация главного цикла демона (run_daemon)
  - Тип: Rust / core / daemon
  - Примечания: реализован полный главный цикл демона с интеграцией всех компонентов. Используются статические бекенды для окон и аудио (реальные бекенды - отдельная задача). Функция collect_snapshot собирает метрики системы, процессов, окон, аудио и ввода, строит Snapshot. Главный цикл применяет группировку, классификацию, политику и actuator с поддержкой гистерезиса.
- [x] ST-017: Построение фич для ML-ранкера в Rust (`model::features`)
  - Тип: Rust / core / model
  - Примечания: реализована структура `FeatureVector` и функция `build_features()`, которая извлекает 33 числовые, 12 булевых и 6 категориальных фич из Snapshot и AppGroup. Поддерживаются дефолты для отсутствующих значений (0.0 для числовых, 0 для булевых, "unknown" для категориальных). Добавлены 3 unit-теста, покрывающие базовый сценарий, дефолты и корректность индексов категориальных фичей.

- [x] ST-018: Каркас ML-ранкера (трейт и заглушка)
  - Тип: Rust / core / model
  - Критерии готовности:
    - Трейт `Ranker` с методом `rank()` для ранжирования AppGroup по фичам;
    - Структура `RankingResult` с score, rank и percentile для каждого AppGroup;
    - Заглушка `StubRanker` для тестирования (возвращает фиксированные scores);
    - Unit-тесты на трейт и заглушку (минимум 2 теста).
  - Примечания: реализован трейт `Ranker` с методом `rank()`, структура `RankingResult` содержит score, rank и percentile. Добавлена заглушка `StubRanker`, которая использует простые эвристики (фокусная группа, GUI, CPU usage) для вычисления scores. Добавлены 2 unit-теста, проверяющие базовое ранжирование и случай с одной группой. Каркас готов для интеграции реальных ML-моделей (ONNX/JSON) в будущем.

- [x] ST-005-2b: PipeWireIntrospector через `pw-dump`
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - Структура `PipeWireIntrospector`, реализующая трейт `AudioIntrospector`;
    - Вызов `pw-dump` через команду и парсинг JSON;
    - Отслеживание XRUN через мониторинг ERR из `pw-dump`;
    - Unit-тесты на парсинг XRUN и создание интроспектора (4 теста).
  - Примечания: реализована структура `PipeWireIntrospector` с методами `audio_metrics()` и `clients()`, которые вызывают `pw-dump` и парсят результат. Добавлена функция `parse_pw_dump_xruns()` для извлечения ERR счётчиков из JSON. Интроспектор отслеживает изменения ERR между вызовами для определения новых XRUN событий. Добавлены 4 unit-теста, покрывающие парсинг XRUN, обработку пустых результатов и игнорирование не-узлов. Интроспектор готов для интеграции в главный цикл демона.

- [x] ST-005-2c: Интеграция PipeWireIntrospector в главный цикл демона
  - Тип: Rust / core / daemon
  - Критерии готовности:
    - Замена `StaticAudioIntrospector::empty()` на `PipeWireIntrospector` в `run_daemon`;
    - Fallback на `StaticAudioIntrospector`, если `pw-dump` недоступен;
    - Обновление комментариев и логирования.
  - Примечания: интегрирован `PipeWireIntrospector` в главный цикл демона (`run_daemon`). Добавлена проверка доступности `pw-dump` при инициализации с автоматическим fallback на `StaticAudioIntrospector`, если PipeWire недоступен. Все существующие тесты проходят (101 тест). Демон теперь использует реальный PipeWire интроспектор для сбора метрик аудио, когда это возможно.

- [x] ST-005-2d: Улучшение отслеживания XRUN (более точное определение новых XRUN, поддержка различных форматов ERR)
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - [x] Расширена поддержка форматов ERR (добавлены варианты: "error", "xrun", "node.error.count", "pipewire.error", "pipewire.xrun");
    - [x] Улучшена логика отслеживания: обработка уменьшения ERR (перезапуск узла), автоматическая очистка исчезнувших узлов;
    - [x] Улучшено вычисление unknown_xruns с использованием saturating_sub для безопасности;
    - [x] Добавлены unit-тесты для различных форматов ERR, уменьшения ERR и исчезновения узлов (5 новых тестов).
  - Примечания: расширена функция parse_err_count для поддержки 10 различных форматов ERR. Улучшена логика в audio_metrics() для корректной обработки случаев, когда ERR уменьшается (перезапуск узла) или узлы исчезают из вывода pw-dump. Добавлены 5 новых unit-тестов, покрывающих различные форматы ERR, строковые значения ERR, уменьшение ERR и исчезновение узлов. Все 106 тестов проекта проходят успешно.

- [x] ST-019: Интеграция ML-ранкера в Policy Engine (hybrid mode)
  - Тип: Rust / core / policy
  - Критерии готовности:
    - [x] Добавлено поле policy_mode в Config (rules-only/hybrid);
    - [x] PolicyEngine поддерживает опциональный Ranker;
    - [x] В hybrid mode используется percentile из ранкера для маппинга на классы приоритетов;
    - [x] Guardrails и семантические правила имеют приоритет над ранкером;
    - [x] Unit-тесты для hybrid mode (3 новых теста).
  - Примечания: реализована интеграция ML-ранкера в Policy Engine. Добавлено поле policy_mode в Config с поддержкой режимов rules-only (по умолчанию) и hybrid. В hybrid mode PolicyEngine использует StubRanker для ранжирования групп и маппит percentile на классы приоритетов через пороги из конфига. Guardrails и семантические правила имеют приоритет над ранкером. Добавлены 3 новых unit-теста, покрывающих использование ранкера, приоритет guardrails и маппинг percentile. Все 110 тестов проекта проходят успешно.

- [x] ST-020: Реализация вычисления bad_responsiveness и responsiveness_score
  - Тип: Rust / core / logging
  - Критерии готовности:
    - [x] Добавлен порог sched_latency_p99_threshold_ms в Config;
    - [x] Реализована функция ResponsivenessMetrics::compute() для вычисления bad_responsiveness и responsiveness_score;
    - [x] bad_responsiveness вычисляется на основе PSI CPU/IO, scheduling latency, XRUN и UI latency;
    - [x] responsiveness_score вычисляется как нормированная комбинация метрик (0.0 = плохо, 1.0 = хорошо);
    - [x] Интеграция в collect_snapshot();
    - [x] Unit-тесты для всех сценариев (8 тестов).
  - Примечания: реализовано вычисление метрик отзывчивости согласно документации tz.md. Добавлен порог sched_latency_p99_threshold_ms в Config с дефолтным значением 10.0 мс. Функция compute() проверяет PSI CPU/IO, scheduling latency, XRUN и UI latency для определения bad_responsiveness. responsiveness_score вычисляется как взвешенная комбинация нормализованных метрик. Добавлены 8 unit-тестов, покрывающих хорошие условия, высокие PSI CPU/IO, высокую scheduling latency, XRUN, множественные проблемы, отсутствие метрик и диапазон score. Все 118 тестов проекта проходят успешно.

- [x] ST-021: Добавление настраиваемого порога ui_loop_p95_threshold_ms
  - Тип: Rust / core / config / logging
  - Критерии готовности:
    - [x] Добавлено поле ui_loop_p95_threshold_ms в Config::Thresholds с дефолтным значением 16.67 мс;
    - [x] Порог используется в ResponsivenessMetrics::compute() вместо хардкода 16.67;
    - [x] Добавлена валидация порога в Thresholds::validate();
    - [x] Обновлены все места создания Thresholds в тестах;
    - [x] Unit-тесты для проверки использования порога (3 новых теста).
  - Примечания: добавлен настраиваемый порог ui_loop_p95_threshold_ms в Config::Thresholds с дефолтным значением 16.67 мс (60 FPS). Порог используется в двух местах в ResponsivenessMetrics::compute(): для определения bad_responsiveness и для нормализации в responsiveness_score. Добавлены 3 новых unit-теста, проверяющих обнаружение высокой UI latency, низкой UI latency и использование кастомного порога. Все 121 тест проекта проходят успешно.

- [x] ST-005-2: Реальный PipeWire/PulseAudio адаптер для AudioIntrospector
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - [x] Парсер `pw-dump` → AudioClientInfo;
    - [x] PipeWireIntrospector через `pw-dump` с отслеживанием XRUN через ERR;
    - [x] Интеграция PipeWireIntrospector в главный цикл демона;
    - [x] Улучшение отслеживания XRUN (поддержка различных форматов ERR, обработка уменьшения ERR, очистка исчезнувших узлов);
    - [x] Unit-тесты для всех компонентов (9 тестов).
  - Примечания: реализован PipeWireIntrospector, который использует `pw-dump` для получения метрик аудио. Поддерживается отслеживание XRUN через различные форматы ERR (10 вариантов). Интроспектор интегрирован в главный цикл демона с автоматическим fallback на StaticAudioIntrospector, если PipeWire недоступен. Добавлены 9 unit-тестов, покрывающих парсинг XRUN, различные форматы ERR, уменьшение ERR и исчезновение узлов. Все тесты проекта проходят успешно.

- [x] ST-022: Реализация export_model для экспорта обученных моделей в различные форматы
  - Тип: Python / trainer
  - Критерии готовности:
    - [x] Реализована функция export_model с поддержкой форматов json, onnx, cbm;
    - [x] Поддержка загрузки моделей из json и cbm;
    - [x] Обработка ошибок (неподдерживаемый формат, отсутствующий файл);
    - [x] Unit-тесты для всех сценариев (6 тестов).
  - Примечания: реализована функция export_model, которая загружает модель CatBoostRanker и экспортирует её в указанный формат. Поддерживаются форматы: onnx, json, cbm. Добавлены 6 unit-тестов, покрывающих экспорт между форматами, обработку ошибок и регистронезависимость формата. Все тесты проходят успешно.

- [x] ST-023: Улучшение поддержки glob паттернов в matches_pattern
  - Тип: Rust / core / classify
  - Критерии готовности:
    - [x] Поддержка `?` (один символ);
    - [x] Поддержка множественных `*` в одном паттерне (например, `firefox-*-bin`);
    - [x] Поддержка комбинаций `*` и `?` (например, `firefox-?-*`);
    - [x] Unit-тесты для всех новых случаев (расширено до 20+ тестов);
    - [x] Обратная совместимость с существующими паттернами.
  - Примечания: реализован полноценный glob matcher с рекурсивным алгоритмом сопоставления. Поддерживаются все комбинации `*` и `?`, включая множественные wildcard символы в одном паттерне. Добавлены расширенные unit-тесты, покрывающие базовые случаи, `?`, множественные `*`, комбинации, пустые строки и граничные случаи. Все 121 тест проекта проходят успешно. Удалён TODO про добавление полноценной поддержки glob/regex.

- [x] ST-024: Исправление предупреждения компилятора: удалить неиспользуемый импорт PathBuf
  - Тип: Rust / core / classify
  - Критерии готовности:
    - [x] Удалён неиспользуемый импорт PathBuf из основного кода;
    - [x] PathBuf импортирован только в блоке тестов, где он используется;
    - [x] Все тесты проходят без предупреждений компилятора.
  - Примечания: исправлено предупреждение компилятора о неиспользуемом импорте PathBuf. Импорт перенесён в блок тестов, где он действительно используется. Все 121 тест проходят успешно.

- [x] ST-025: Реализация X11Introspector для получения информации об окнах через EWMH (X11)
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - [x] Структура `X11Introspector`, реализующая трейт `WindowIntrospector`;
    - [x] Получение списка окон через EWMH (`_NET_CLIENT_LIST`);
    - [x] Получение информации об окне: title, app_id, workspace, state (focused/minimized/fullscreen);
    - [x] Получение PID через `_NET_WM_PID`;
    - [x] Определение фокусного окна через `_NET_ACTIVE_WINDOW`;
    - [x] Unit-тесты на парсинг окон и обработку ошибок (5 тестов);
    - [x] Fallback на StaticWindowIntrospector, если X11 недоступен.
  - Примечания: реализован X11Introspector с полной поддержкой EWMH. Добавлена зависимость x11rb в Cargo.toml. Интроспектор получает список окон, PID, состояние (focused/minimized/fullscreen), workspace, title и app_id через стандартные EWMH-атомы. Интегрирован в главный цикл демона с автоматическим fallback на StaticWindowIntrospector, если X-сервер недоступен. Добавлены 5 unit-тестов, покрывающих создание интроспектора, получение окон, фокусного окна и валидность структуры WindowInfo. Все 126 тестов проекта проходят успешно.

- [x] ST-026: Интеграция реального evdev для InputActivityTracker (чтение событий из /dev/input)
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - [x] Структура `EvdevInputTracker`, которая читает события из `/dev/input/*`;
    - [x] Автоматическое обнаружение доступных устройств ввода (клавиатура, мышь);
    - [x] Подписка на события через evdev-библиотеку;
    - [x] Интеграция с `InputActivityTracker` для обновления метрик;
    - [x] Unit-тесты на чтение событий и обработку ошибок (4 теста);
    - [x] Fallback на статический трекер, если evdev недоступен.
  - Примечания: реализован EvdevInputTracker, который автоматически обнаруживает доступные устройства ввода в `/dev/input/event*` и читает события в неблокирующем режиме. Создан enum InputTracker для абстракции между EvdevInputTracker и InputActivityTracker. Интегрирован в главный цикл демона с автоматическим fallback на простой трекер, если evdev устройства недоступны. Добавлены 4 unit-теста, покрывающих проверку доступности, создание трекера и получение метрик. Все 129 тестов проекта проходят успешно.

## 4. Блокеры

- [!] ST-099: Вернуть зависимость onnxruntime, когда появится стабильная версия с нужными фичами
  - Нужны: релиз onnxruntime с требуемыми возможностями.
