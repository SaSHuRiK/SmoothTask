# SmoothTask — план задач

## Легенда статусов

- [ ] TODO       — задача ещё не делалась
- [~] IN PROGRESS — начата, но не завершена
- [x] DONE       — реализовано и покрыто тестами
- [!] BLOCKED    — есть блокер, нужна дополнительная информация

---

## 1. Ближайшие шаги (Next Up)

- [x] ST-011-1: Сбор метрик процессов из /proc (легкие метрики)
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - Функция `collect_process_metrics()` для сбора метрик всех процессов;
    - Чтение из `/proc/[pid]/stat`, `/proc/[pid]/status`, `/proc/[pid]/cmdline`, `/proc/[pid]/cgroup`;
    - Заполнение базовых полей ProcessRecord (pid, ppid, uid, gid, exe, cmdline, cgroup_path, state, start_time, nice, rss_mb);
    - Unit-тесты на парсинг фиктивных данных из /proc;
    - Обработка ошибок доступа к процессам (процесс завершился, нет прав).
  - Примечания: реализован модуль `metrics::process` с функцией `collect_process_metrics()`, использующей библиотеку `procfs` для чтения метрик процессов. Добавлены вспомогательные функции для чтения cgroup_path, systemd_unit, UID/GID и переменных окружения. Добавлены 6 unit-тестов, покрывающих парсинг cgroup, извлечение systemd unit, чтение переменных окружения и обработку ошибок.

- [x] ST-010-1: Планировщик изменений Actuator (nice/ionice без системных вызовов)
  - Тип: Rust / core / actuator
  - Критерии готовности:
    - Структуры для описания желаемых изменений per-pid (nice/ionice, причина);
    - Функция планирования на основе Snapshot и результатов Policy (priority_class);
    - Игнорирование процессов, для которых значения уже соответствуют целевым;
    - Unit-тесты на вычисление диффов и фильтрацию без изменений.
  - Примечания: добавлен планировщик `plan_priority_changes`, формирующий диффы по nice/ionice на основе PolicyResult; покрыт 3 юнит-тестами.

- [x] ST-009: Policy Engine: применение жёстких и семантических правил
  - Тип: Rust / core / policy
  - Критерии готовности:
    - Реализация жёстких правил (guardrails): защита системных процессов, RT-приоритеты, аудио, batch-группы;
    - Реализация семантических правил: фокусный GUI, активный терминал, updater/indexer, noisy neighbour;
    - Unit-тесты для всех правил (7 тестов);
    - API `PolicyEngine::evaluate_snapshot()` готово для использования в главном цикле демона.
  - Примечания: реализованы все основные правила согласно POLICY.md. Добавлены 7 unit-тестов, покрывающих все сценарии правил. Policy Engine определяет приоритеты для AppGroup на основе метрик и контекста.

- [x] ST-005-2a: Парсер `pw-dump` → AudioClientInfo
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - Функция для извлечения PID аудио-клиентов из `pw-dump`;
    - Парсинг node.latency для buffer_size/sample_rate;
    - Агрегация дубликатов PID без перезаписи надёжных значений;
    - Unit-тесты на базовые кейсы и альтернативный формат (`objects`).
  - Примечания: добавлен модуль `metrics::audio_pipewire` с парсером `parse_pw_dump_clients`, 3 юнит-теста.

- [x] ST-012: Построение фич для тренера (`build_feature_matrix`)
  - Тип: Python / trainer
  - Критерии готовности:
    - Реализована функция `build_feature_matrix()` на основе данных `load_snapshots_as_frame`;
    - Поддержка числовых, булевых и категориальных фич с корректными cat_feature indices;
    - Таргет берётся из `teacher_score` с запасным вариантом `responsiveness_score`;
    - Unit-тесты покрывают базовый сценарий и fallback таргета.
  - Примечания: реализована трансформация с дефолтами и cat-индексами, добавлены тесты.

- [x] ST-013: Unit-тесты для train_ranker модуля
  - Тип: Python / trainer
  - Критерии готовности:
    - Тесты на базовое обучение ранкера с сохранением модели в JSON;
    - Тесты на обучение с экспортом в ONNX;
    - Тесты на обработку пустой БД;
    - Тесты на fallback таргета (responsiveness_score вместо teacher_score);
    - Все тесты проходят успешно.
  - Примечания: добавлены 4 unit-теста в `tests/test_train_ranker.py`, покрывающие основные сценарии использования `train_ranker`. Тесты проверяют сохранение моделей, обработку ошибок и корректность параметров обученной модели.


## 2. Бэклог

- [x] ST-010: Actuator: применение приоритетов через nice/ionice/cgroups
  - Тип: Rust / core / actuator
  - Критерии готовности:
    - [x] Применение nice через setpriority;
    - [x] Применение ionice через ioprio_set;
    - [x] Управление cgroups v2 (cpu.weight через прямое управление файловой системой);
    - [x] Гистерезис для предотвращения частых изменений;
    - [x] Unit-тесты на применение приоритетов (13 тестов, покрывают гистерезис, логику планирования и работу с cgroups).
  - Примечания: реализованы функции apply_nice() и apply_ionice() через libc, добавлен HysteresisTracker с настраиваемыми параметрами (min_time_between_changes, min_class_difference), функция apply_priority_adjustments() применяет изменения с учётом гистерезиса. Полностью реализовано управление cgroups v2 через функции read_process_cgroup(), get_or_create_app_cgroup(), set_cpu_weight(), move_process_to_cgroup() и apply_cgroup(). Добавлены 13 unit-тестов, покрывающих все аспекты работы Actuator.

- [ ] ST-005-2: Реальный PipeWire/PulseAudio адаптер для AudioIntrospector
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - Подключение к PipeWire или PulseAudio;
    - Подписка на события XRUN;
    - Получение списка активных клиентов с PID;
    - Интеграционные тесты с реальным аудио-стеком (опционально).
  - Примечания: частично подготовлено — парсер `pw-dump` в `metrics::audio_pipewire`.

## 3. Готово (Done)

- [x] ST-000: Валидация конфигурации при загрузке
  - Примечания: покрыто юнит-тестом загрузки `Config::load`.
- [x] ST-003: Сбор пользовательского ввода (evdev) для user_active/idle
  - Примечания: добавлен `InputActivityTracker` с юнит-тестами, считает `user_active` и `time_since_last_input_ms` без зависимости от реального `/dev/input`.
- [x] ST-006: Классы приоритетов и маппинг на nice/ionice/cgroup
  - Примечания: реализованы все классы приоритетов с маппингом согласно POLICY.md, добавлены 10 unit-тестов, поддержка serde для сериализации.
- [x] ST-005-1: Каркас аудио метрик (структуры, трейт, статический бекенд)
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - Структуры `AudioMetrics`, `AudioClientInfo`, `XrunInfo`;
    - Трейт `AudioIntrospector` с методами `audio_metrics()` и `clients()`;
    - `StaticAudioIntrospector` для тестов;
    - Unit-тесты на все компоненты (8 тестов).
  - Примечания: реализованы нормализованные структуры данных для XRUN событий и аудио-клиентов, трейт для абстракции бекендов, статический бекенд для тестов. Добавлены 8 unit-тестов, покрывающих основные сценарии. API готово для интеграции реальных PipeWire/PulseAudio адаптеров.
- [x] ST-004: Каркас WindowIntrospector и выбор фокусного окна
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - Нормализованные структуры `WindowInfo`/`WindowState`;
    - Каркас интерфейса `WindowIntrospector` с базовым бекендом-заглушкой;
    - Юнит-тесты на выбор активного окна и корректность confidence.
  - Примечания: реализованы структуры и статический бекенд; выбор активного окна учитывает `pid_confidence`; добавлены функции `get_window_info_by_pid()` и `build_pid_to_window_map()`; покрыто 12 unit-тестами. Реальный X11/Wayland адаптер - отдельная задача из бэклога.
- [x] ST-007: Process Grouper для группировки процессов в AppGroup
  - Тип: Rust / core / classify
  - Критерии готовности:
    - Модуль `classify::grouper` с функцией `group_processes()`;
    - Группировка по cgroup_path (с нормализацией);
    - Группировка по дереву процессов (root и потомки);
    - Определение root_pid для каждой группы;
    - Агрегация метрик группы (CPU, IO, память, GUI, теги);
    - Unit-тесты на все сценарии группировки (8 тестов).
  - Примечания: реализован алгоритм группировки процессов в AppGroup с поддержкой группировки по cgroup и дереву процессов. Добавлены 8 unit-тестов, покрывающих пустой список, одиночный процесс, дерево процессов, группировку по cgroup, множественные группы, нормализацию cgroup, агрегацию метрик и независимые деревья.
- [x] ST-008-1: Структуры данных для паттернов и загрузка из YAML
  - Тип: Rust / core / classify
  - Критерии готовности:
    - Структуры для представления паттернов приложений (AppPattern, PatternCategory);
    - Загрузка паттернов из YAML файлов в директории patterns;
    - Поддержка сопоставления по exe_patterns, desktop_patterns, cgroup_patterns;
    - Unit-тесты на загрузку и парсинг паттернов.
  - Примечания: реализованы структуры PatternDatabase, AppPattern, PatternFile с загрузкой из YAML. Поддержка простых wildcard паттернов (*, ?). Добавлены 7 unit-тестов на загрузку и сопоставление паттернов.
- [x] ST-008-2: Классификатор процессов по паттернам
  - Тип: Rust / core / classify
  - Критерии готовности:
    - Функция классификации процессов и AppGroup по паттернам;
    - Заполнение process_type и tags в ProcessRecord;
    - Агрегация тегов для AppGroupRecord;
    - Unit-тесты на классификацию различных процессов.
  - Примечания: реализованы функции classify_process(), classify_app_group() и classify_all() для классификации процессов и групп по паттернам. Заполняются process_type и tags. Добавлены 4 unit-теста на классификацию (всего 11 тестов в модуле).
- [x] ST-009: Policy Engine: применение жёстких и семантических правил
  - Тип: Rust / core / policy
  - Критерии готовности:
    - Реализация жёстких правил (guardrails): защита системных процессов, RT-приоритеты, аудио, batch-группы;
    - Реализация семантических правил: фокусный GUI, активный терминал, updater/indexer, noisy neighbour;
    - Unit-тесты для всех правил (7 тестов);
    - API `PolicyEngine::evaluate_snapshot()` готово для использования в главном цикле демона.
  - Примечания: реализованы все основные правила согласно POLICY.md. Добавлены 7 unit-тестов, покрывающих все сценарии правил. Policy Engine определяет приоритеты для AppGroup на основе метрик и контекста.

- [x] ST-006: Классы приоритетов и маппинг на nice/ionice/cgroup
  - Примечания: реализованы все классы приоритетов с маппингом согласно POLICY.md, добавлены 10 unit-тестов, поддержка serde для сериализации.

- [x] ST-001: Глобальные метрики /proc + PSI
  - Примечания: реализованы парсеры и фиктивный /proc в тестах.

- [x] ST-002: Экспорт снапшотов в SQLite и чтение в трейнере
  - Примечания: реализованы тесты для записи (Rust) и чтения (Python), исправлена ошибка с количеством колонок в INSERT-запросе.
- [x] ST-010-2: Полная реализация управления cgroups v2
  - Тип: Rust / core / actuator
  - Критерии готовности:
    - [x] Определение cgroup процесса из /proc/[pid]/cgroup;
    - [x] Создание/использование cgroups для AppGroup (через прямое управление файловой системой);
    - [x] Установка cpu.weight через запись в /sys/fs/cgroup/.../cpu.weight;
    - [x] Перемещение процессов в нужные cgroups через cgroup.procs;
    - [x] Unit-тесты на парсинг cgroup и создание путей (4 теста).
  - Примечания: реализованы функции read_process_cgroup(), get_or_create_app_cgroup(), set_cpu_weight(), move_process_to_cgroup() и apply_cgroup(). Cgroups создаются под /sys/fs/cgroup/smoothtask/app-{app_group_id}. Добавлены 4 unit-теста, покрывающих парсинг cgroup v2 формата, обработку несуществующих PID, определение корня cgroup и создание путей для AppGroup. Реализация использует прямое управление файловой системой вместо cgroups-rs API, что является стандартным подходом в Linux.

## 4. Блокеры

- [!] ST-099: Вернуть зависимость onnxruntime, когда появится стабильная версия с нужными фичами
  - Нужны: релиз onnxruntime с требуемыми возможностями.
