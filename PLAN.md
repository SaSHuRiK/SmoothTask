# SmoothTask — план задач

## Легенда статусов

- [ ] TODO       — задача ещё не делалась
- [~] IN PROGRESS — начата, но не завершена
- [x] DONE       — реализовано и покрыто тестами
- [!] BLOCKED    — есть блокер, нужна дополнительная информация

---

## 1. Ближайшие шаги (Next Up)

- [x] ST-357: Улучшить обработку ошибок в метриках с более информативными сообщениями
  - Тип: Rust / core / metrics
  - Критерии готовности:
    - Добавить контекст к ошибкам чтения /proc и других системных ресурсов;
    - Улучшить сообщения об ошибках в метриках процессов, окон, аудио;
    - Unit-тесты проверяют наличие контекста в ошибках.
  - Примечания: Улучшены сообщения об ошибках в system.rs, process.rs и audio_pipewire.rs. Добавлен более детальный контекст о возможных причинах ошибок и ожидаемых форматах данных.

- [x] ST-358: Добавить документацию по использованию train_ranker в README trainer
  - Тип: Python / trainer / docs
  - Критерии готовности:
    - Добавить примеры использования train_ranker в README;
    - Описать формат входных данных и выходных моделей;
    - Добавить примеры команд для обучения модели.
  - Примечания: Добавлена полная документация в README.md с примерами использования, описанием форматов данных, параметров модели и интеграции с SmoothTask.

## 2. Бэклог

- [ ] ST-117: Оптимизация производительности критических путей (если необходимо)
  - Тип: Rust / core / performance
  - Критерии готовности:
    - Определены узкие места производительности;
    - Оптимизированы критические пути;
    - Добавлены бенчмарки для проверки улучшений.

- [x] ST-207: Добавить интеграцию с systemd для автозапуска
  - Тип: Rust / systemd
  - Примечания: полностью выполнено. ST-209 создал unit файл, ST-210 добавил поддержку systemd notify, ST-211 добавил документацию. Интеграция с systemd завершена.

- [x] ST-208: Добавить Control API (HTTP/gRPC) для просмотра состояния
  - Тип: Rust / core / api
  - Подзадачи:
    - [x] ST-213: Базовая структура для HTTP сервера
    - [x] ST-214: Endpoint для статистики демона
    - [x] ST-215: Endpoint для просмотра метрик системы
    - [x] ST-216: Endpoint для просмотра процессов и AppGroup
    - [x] ST-217: Интеграция API сервера в run_daemon
    - [x] ST-218: Документация API
  - Примечания: полностью реализован HTTP API для просмотра текущего состояния демона. Все подзадачи выполнены. API сервер интегрирован в главный цикл демона, данные обновляются при каждой итерации. Добавлена полная документация API в docs/API.md. Все 82 теста проходят успешно.

## 3. Недавно сделано (Recently Done)

- [x] ST-358: Добавить документацию по использованию train_ranker в README trainer
  - Тип: Python / trainer / docs
  - Примечания: Добавлена полная документация в README.md с примерами использования, описанием форматов данных, параметров модели и интеграции с SmoothTask.

- [x] ST-357: Улучшить обработку ошибок в метриках с более информативными сообщениями
  - Тип: Rust / core / metrics
  - Примечания: Улучшены сообщения об ошибках в system.rs, process.rs и audio_pipewire.rs. Добавлен более детальный контекст о возможных причинах ошибок и ожидаемых форматах данных.

- [x] ST-356: Добавить валидацию формата api_listen_addr в конфигурации
  - Тип: Rust / core / config
  - Примечания: Добавлена валидация формата адреса (host:port) в Paths::validate с проверкой, что порт в допустимом диапазоне (1-65535). Добавлена функция validate_api_listen_addr с информативными сообщениями об ошибках. Добавлены unit-тесты на валидные и невалидные адреса (11 тестов). Все 86 тестов модуля config проходят успешно. Прогнан `cargo test --package smoothtask-core --lib config::tests`.

- [x] ST-354: Улучшить обработку ошибок в export_model с более информативными сообщениями
  - Тип: Python / trainer / export_model
  - Примечания: Добавлена обработка ошибок при загрузке и сохранении моделей с информативными сообщениями. Добавлены тесты на невалидные файлы моделей и ошибки сохранения. Прогнан `uv run python -m pytest smoothtask-trainer/tests/test_export_model.py`.

- [x] ST-353: Добавить тесты на обработку ошибок CatBoost в train_ranker
  - Тип: Python / trainer / train_ranker
  - Примечания: Добавлены тесты на валидацию путей к БД и моделям, проверку директорий вместо файлов, создание родительских директорий. Исправлены тестовые данные для корректной работы с валидацией фич. Прогнан `uv run python -m pytest smoothtask-trainer/tests/test_train_ranker.py`.

- [x] ST-352: Добавить валидацию параметров train_ranker (проверка путей, форматов)
  - Тип: Python / trainer / train_ranker
  - Примечания: Добавлена валидация входных параметров (проверка существования БД, что пути указывают на файлы, а не директории), улучшена обработка ошибок при обучении и сохранении моделей с информативными сообщениями. Прогнан `uv run python -m pytest smoothtask-trainer/tests/test_train_ranker.py`.

- [x] ST-351: Улучшить валидацию ошибок булевых колонок в dataset
  - Тип: Python / trainer / dataset
  - Примечания: Сообщения об ошибках булевых колонок включают допустимые значения, добавлен тест на падение при строках "yes"/"maybe". Прогнан `uv run python -m pytest smoothtask-trainer/tests/test_dataset.py`.

- [x] ST-350: Поддержать строковые true/false в булевых колонках load_snapshots_as_frame
  - Тип: Python / trainer / dataset
  - Примечания: _coerce_bool_column принимает строки true/false в любом регистре, новые тесты подтверждают корректную конвертацию булевых колонок snapshots/processes/app_groups. Прогнан `uv run python -m pytest smoothtask-trainer/tests/test_dataset.py`.

- [x] ST-349: Нормализовать пробелы в tags при сборке категориальных фич
  - Тип: Python / trainer / features
  - Примечания: _prepare_tags_column триммит строки и элементы коллекций, пустые значения превращаются в "unknown"; добавлен тест на пробелы и пустые строки. Прогнан `uv run python -m pytest smoothtask-trainer/tests/test_features.py`.

- [x] ST-348: Поддержать строковые true/false в булевых фичах build_feature_matrix
  - Тип: Python / trainer / features
  - Примечания: _coerce_boolean принимает строки "true"/"false" в любом регистре наряду с 0/1; добавлен тест на корректную обработку строковых булевых значений. Прогнан `uv run python -m pytest smoothtask-trainer/tests/test_features.py`.

- [x] ST-347: Отклонять невалидные timestamp строки в snapshots
  - Тип: Python / trainer / dataset
  - Примечания: load_snapshots_as_frame валидирует timestamp и падает с ValueError, если дата не парсится; добавлен юнит-тест на строку "not-a-date". Прогнан `uv run python -m pytest smoothtask-trainer/tests/test_dataset.py`.

- [x] ST-346: Валидировать timestamp снапшотов при загрузке SQLite
  - Тип: Python / trainer / dataset
  - Примечания: добавлена обязательность timestamp и проверка NaN/NaT с указанием строк и примеров; новые тесты на пустой timestamp и invalid строки проходят. Прогнан `uv run python -m pytest smoothtask-trainer/tests/test_dataset.py`.

- [x] ST-345: Запретить отрицательные PID в process_ids групп
  - Тип: Python / trainer / dataset
  - Примечания: `_parse_process_ids` теперь отклоняет отрицательные и бесконечные PID с понятным ValueError; добавлен unit-тест на ошибку и проверено сохранение дедупликации. Прогнан `uv run python -m pytest smoothtask-trainer/tests/test_dataset.py`.

- [x] ST-344: Валидировать app_group_id как непустое строковое значение
  - Тип: Python / trainer / dataset
  - Примечания: `load_snapshots_as_frame` проверяет app_group_id в app_groups на непустые строки, выдаёт ошибку с примерами некорректных значений; добавлен тест на пустой app_group_id. Прогнан `uv run python -m pytest smoothtask-trainer/tests/test_dataset.py`.

- [x] ST-343: Удалять дубликаты process_ids при парсинге app_groups
  - Тип: Python / trainer / dataset
  - Примечания: _parse_process_ids убирает дубликаты с сохранением порядка; добавлен unit-тест на стабильное множество pid и обновлён интеграционный тест на process_ids.

- [x] ST-342: Не допускать пустых таблиц snapshots/processes в trainer
  - Тип: Python / trainer / dataset
  - Примечания: load_snapshots_as_frame теперь выбрасывает понятный ValueError, если таблицы snapshots или processes пусты; покрыто двумя unit-тестами.

См. архив: docs/history/PLAN_DONE_archive.md

## 4. Блокеры

- [!] ST-011: Реализация WaylandIntrospector для поддержки Wayland-композиторов
  - Тип: Rust / core / metrics
  - Подзадачи:
    - [x] ST-011-1: Добавить зависимости wayland-client и wayland-protocols-wlr
    - [~] ST-011-2: Реализовать базовое подключение к Wayland композитору в WaylandIntrospector::new()
      - Примечания: Исправлены ошибки компиляции, упрощена структура. Полная реализация требует сложной работы с асинхронными событиями через wayland-client 0.31 API с использованием Dispatch трейтов для обработки событий реестра и wlr-foreign-toplevel-management протокола. Это выходит за рамки простой задачи (~30 минут) и требует дополнительного времени на изучение правильного использования wayland-client API. Код компилируется, тесты проходят.
    - [~] ST-011-3: Реализовать получение списка окон через wlr-foreign-toplevel-management протокол
      - Примечания: Зависит от ST-011-2. Требует правильной обработки событий через Dispatch трейты wayland-client для регистрации обработчиков событий toplevel (title, app_id, state, pid) и синхронизации состояния окон. Это сложная задача, требующая правильной работы с асинхронными событиями.
    - [x] ST-011-4: Добавить unit-тесты для WaylandIntrospector
      - Примечания: Добавлены базовые unit-тесты для проверки доступности и создания интроспектора. Тесты корректно обрабатывают случаи, когда Wayland недоступен или реализация не завершена. Все 6 тестов проходят успешно.
  - Критерии готовности:
    - Реализация WaylandIntrospector через wlr-foreign-toplevel-management;
    - Поддержка основных композиторов (Mutter, KWin, Sway, Hyprland);
    - Fallback на StaticWindowIntrospector, если Wayland недоступен;
    - Unit-тесты на парсинг окон и обработку ошибок.
  - Примечания: Wayland требует работы с wayland-client и специфичными протоколами композиторов. Это более сложная задача, чем X11. Базовая структура и функция проверки доступности уже реализованы в ST-039. Зависимости добавлены в ST-011-1. Создана базовая структура с заглушками и тестами. Полная реализация требует дополнительного времени на изучение правильного использования wayland-client 0.31 API для обработки асинхронных событий через Dispatch трейты. Код компилируется без ошибок, все тесты проходят. Задача блокирована, так как требует значительного времени на изучение wayland-client API и правильной работы с асинхронными событиями. Это выходит за рамки простой задачи (~30 минут).

- [!] ST-099: Вернуть зависимость onnxruntime, когда появится стабильная версия с нужными фичами
  - Нужны: релиз onnxruntime с требуемыми возможностями.
