# Политика приоритетов SmoothTask

## Классы приоритетов

| Class            | nice | ionice class/level | cpu.weight | Описание                         |
| ---------------- | ---- | ------------------ | ---------: | -------------------------------- |
| CRIT_INTERACTIVE | -8   | 2 / 0–1            |        200 | фокус + аудио/игра               |
| INTERACTIVE      | -4   | 2 / 2–3            |        150 | обычный UI/CLI                   |
| NORMAL           | 0    | 2 / 4              |        100 | дефолт                           |
| BACKGROUND       | +5   | 2 / 6              |         50 | batch / maintenance              |
| IDLE             | +10  | 3 (idle)           |         25 | всё, что можно делать «на остатке» |

## Жёсткие правила (guardrails)

Эти правила не подлежат авто-тюнингу:

1. **Не трогать системные процессы**
   - `systemd`, `journald`, `udevd`
   - Критичные сетевые и дисковые демоны

2. **Не использовать RT-приоритеты**
   - Никаких `SCHED_FIFO/RR` для пользовательских процессов
   - Никаких `nice < -10`

3. **Защита аудио**
   - Не опускать `audio_client` ниже `INTERACTIVE`, если есть XRUN на низком буфере

4. **Ограничение batch-групп**
   - Не превышать суммарный вес batch-групп относительно total CPU

## Семантические правила

### Примеры

1. **Фокусный GUI-AppGroup**
   - Всегда ≥ `INTERACTIVE`
   - Всегда ≥ свернутых приложений

2. **Активный терминал**
   - Терминал с недавним вводом ≥ свернутым batch-процессам

3. **Updater/indexer при активном пользователе**
   - Максимум `BACKGROUND/IDLE`

4. **Noisy neighbour**
   - Если вкладка/renderer в фоне жрёт CPU, а отзывчивость падает
   - → душить эту группу, а не всё приложение

## ML-ранкер

### Входные данные

На каждый snapshot:
- Список кандидатов (процессы/AppGroup)
- Глобальные фичи (PSI, load, mem, responsiveness)
- Per-process фичи (CPU/IO/RSS, контекст)
- Типы и теги
- Состояние окна (focus/background/minimized)

### Выход

- Score для каждого кандидата
- Rank и percentile на основе score

### Маппинг score → класс

Параметризуемые пороги (percentiles):
- `p >= p_crit` → `CRIT_INTERACTIVE`
- `p_crit > p >= p_inter` → `INTERACTIVE`
- `p_inter > p >= p_norm` → `NORMAL`
- `p_norm > p >= p_back` → `BACKGROUND`
- `< p_back` → `IDLE`

## Гистерезис

Класс приоритета меняется только если:
- Условие держится N снапшотов подряд
- Разница классов ≥ 1 (не мельтешим между соседями)
- Можно ввести `min_time_in_class`

## Режимы работы

1. **rules-only** — только правила, без ML
2. **hybrid** — правила + CatBoostRanker
3. **dry-run** — ML считает, но не применяет изменения

