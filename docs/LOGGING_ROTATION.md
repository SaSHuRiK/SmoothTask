# Система логирования и ротации логов

SmoothTask предоставляет расширенную систему логирования и ротации логов для обеспечения надежного хранения и управления логами приложения.

## Обзор системы логирования

Система логирования SmoothTask включает несколько компонентов:

1. **AppLogRotator** - Основной компонент для ротации логов приложения
2. **LogStorage** - Хранилище логов с поддержкой ротации по времени и памяти
3. **Snapshot Logger** - Логирование снапшотов для обучения ML-моделей

## AppLogRotator

`AppLogRotator` - это основной компонент для автоматической ротации логов приложения, создаваемых через `tracing`.

### Функциональность

- **Ротация по размеру**: Автоматическая ротация при достижении заданного размера файла
- **Ротация по времени**: Регулярная ротация через заданные интервалы
- **Сжатие логов**: Поддержка сжатия ротированных логов в формате gzip
- **Управление количеством файлов**: Автоматическое удаление старых ротированных файлов
- **Улучшенная обработка ошибок**: Детальные сообщения об ошибках с рекомендациями по устранению

### Конфигурация

```rust
AppLogRotator::new(
    log_path: impl AsRef<Path>,      // Путь к основному файлу лога
    max_size_bytes: u64,             // Максимальный размер файла лога в байтах
    max_rotated_files: u32,          // Максимальное количество сохраняемых ротированных логов
    compression_enabled: bool,       // Включить сжатие ротированных логов
    rotation_interval_sec: u64,      // Интервал ротации логов по времени в секундах
)
```

### Пример использования

```rust
use smoothtask_core::logging::app_rotation::AppLogRotator;

let mut rotator = AppLogRotator::new(
    "/var/log/smoothtask/app.log",
    10_000_000,  // 10 MB
    5,           // Сохранять 5 ротированных файлов
    true,        // Включить сжатие
    86400,       // Ротация каждые 24 часа
);

// Проверка необходимости ротации
let current_size = std::fs::metadata("/var/log/smoothtask/app.log")?.len();
if rotator.needs_rotation(current_size)? {
    rotator.rotate_log()?;
}
```

### Формат ротированных файлов

Ротированные файлы имеют формат:
```
{original_name}.{timestamp}.log
{original_name}.{timestamp}.log.gz  (если включено сжатие)
```

Примеры:
- `app.20231212_143022.log`
- `app.20231212_143022.log.gz`

### Обработка ошибок

Компонент предоставляет детальные сообщения об ошибках с рекомендациями:

- **Ошибки доступа к файлу**: Проверка прав доступа и существования файла
- **Ошибки перемещения файлов**: Рекомендации по проверке прав доступа
- **Ошибки сжатия**: Информация о проблемах сжатия и рекомендации

## LogStorage

`LogStorage` - это хранилище логов с поддержкой ротации по времени и памяти.

### Функциональность

- **Ротация по времени**: Автоматическая ротация через заданные интервалы
- **Очистка по памяти**: Автоматическое удаление старых записей при превышении лимита памяти
- **Оценка использования памяти**: Точная оценка использования памяти для эффективной очистки
- **Memory-aware операции**: Операции добавления с проверкой памяти

### Конфигурация

```rust
LogStorage::new(
    max_entries: usize,              // Максимальное количество записей
    rotation_interval: Duration,     // Интервал ротации
    memory_limit_bytes: Option<u64>, // Лимит памяти в байтах
)
```

### Пример использования

```rust
use smoothtask_core::logging::log_storage::LogStorage;

let mut storage = LogStorage::new(
    1000,                          // Максимум 1000 записей
    Duration::from_secs(3600),     // Ротация каждый час
    Some(10_000_000),              // Лимит памяти 10 MB
);

// Добавление записи с проверкой памяти
storage.add_entry_with_memory_check(
    "Process started".to_string(),
    chrono::Utc::now(),
)?;
```

### Memory-aware операции

Компонент поддерживает операции с проверкой памяти:

- `add_entry_with_memory_check()`: Добавление записи с автоматической очисткой при превышении лимита
- `estimate_memory_usage()`: Оценка текущего использования памяти
- `cleanup_by_memory()`: Очистка по лимиту памяти

## Интеграция с системой

### Интеграция с основным циклом демона

```rust
// В основном цикле демона
let mut rotator = AppLogRotator::new(
    config.paths.log_file.clone(),
    config.logging.max_log_size,
    config.logging.max_rotated_files,
    config.logging.compression_enabled,
    config.logging.rotation_interval_sec,
);

// Регулярная проверка и ротация
if rotator.needs_rotation(current_log_size)? {
    rotator.rotate_log()?;
}
```

### Интеграция с системой мониторинга

```rust
// Мониторинг состояния логирования
let health_status = HealthStatus {
    log_storage_healthy: storage.is_healthy(),
    log_rotation_healthy: rotator.is_healthy(),
    memory_usage: storage.estimate_memory_usage(),
    // ... другие метрики
};
```

## Конфигурация в YAML

```yaml
logging:
  # Настройки ротации логов приложения
  max_log_size: 10485760          # 10 MB
  max_rotated_files: 5            # Сохранять 5 ротированных файлов
  compression_enabled: true       # Включить сжатие
  rotation_interval_sec: 86400     # Ротация каждые 24 часа
  
  # Настройки хранилища логов
  max_entries: 1000               # Максимум 1000 записей
  rotation_interval: 3600          # Ротация каждый час (в секундах)
  memory_limit_bytes: 10485760     # Лимит памяти 10 MB
```

## Рекомендации по настройке

### Для производственных систем

- **Размер лога**: 10-50 MB в зависимости от частоты логирования
- **Количество ротированных файлов**: 5-10 для баланса между хранением и использованием диска
- **Сжатие**: Включить для экономии дискового пространства
- **Интервал ротации**: 24 часа для большинства случаев
- **Лимит памяти**: 10-50 MB для баланса между производительностью и использованием памяти

### Для систем с высокой нагрузкой

- **Размер лога**: 50-100 MB для уменьшения частоты ротации
- **Количество ротированных файлов**: 10-20 для более длительного хранения
- **Интервал ротации**: 12-24 часа для баланса
- **Лимит памяти**: 50-100 MB для обработки большого объема данных

### Для систем с ограниченными ресурсами

- **Размер лога**: 5-10 MB для экономии дискового пространства
- **Количество ротированных файлов**: 3-5 для минимального использования диска
- **Сжатие**: Включить для максимальной экономии
- **Интервал ротации**: 6-12 часов для более частой очистки
- **Лимит памяти**: 5-10 MB для минимального использования памяти

## Устранение неполадок

### Проблемы с ротацией

1. **Ошибки доступа к файлу**:
   - Проверьте права доступа к файлу лога
   - Убедитесь, что файл существует и доступен для чтения/записи
   - Проверьте, что пользователь, под которым запущен демон, имеет права на файл

2. **Ошибки перемещения файлов**:
   - Проверьте права доступа к директории
   - Убедитесь, что достаточно места на диске
   - Проверьте, что файл не используется другими процессами

3. **Ошибки сжатия**:
   - Проверьте права доступа к временным файлам
   - Убедитесь, что достаточно места на диске
   - Проверьте, что библиотека сжатия доступна

### Проблемы с хранилищем логов

1. **Превышение лимита памяти**:
   - Увеличьте лимит памяти в конфигурации
   - Уменьшите количество сохраняемых записей
   - Увеличьте частоту ротации

2. **Ошибки добавления записей**:
   - Проверьте, что хранилище не переполнено
   - Убедитесь, что лимит памяти не превышен
   - Проверьте, что интервал ротации не слишком большой

## Мониторинг и метрики

Система предоставляет метрики для мониторинга:

- **Текущий размер лога**: Размер основного файла лога
- **Количество ротированных файлов**: Текущее количество ротированных файлов
- **Использование памяти**: Текущее использование памяти хранилищем логов
- **Состояние здоровья**: Общее состояние системы логирования
- **Ошибки ротации**: Количество ошибок при ротации

Эти метрики доступны через API и могут быть интегрированы с системами мониторинга.