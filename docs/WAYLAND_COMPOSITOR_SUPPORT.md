# Поддержка Wayland композиторов

SmoothTask предоставляет расширенную поддержку различных Wayland композиторов для мониторинга окон и приложений.

## Обзор поддержки Wayland

Wayland - это современный протокол для управления окнами в Linux, который заменяет X11. В отличие от X11, Wayland не имеет стандартного API для получения списка всех окон, поэтому каждый композитор реализует свои собственные расширения.

### Поддерживаемые композиторы

SmoothTask поддерживает следующие Wayland композиторы:

1. **Mutter** (GNOME)
2. **KWin** (KDE Plasma)
3. **Sway** (i3-совместимый тайлинговый менеджер)
4. **Hyprland** (современный динамический тайлинговый менеджер)
5. **Wayfire** (композитный менеджер с модульной архитектурой)
6. **River** (динамический тайлинговый менеджер)

### Используемые протоколы

- **`wlr-foreign-toplevel-management-unstable-v1`**: Основной протокол для управления окнами
- **`ext-foreign-toplevel-list`**: Расширенный протокол для списка окон
- **Специфичные расширения композиторов**: Для дополнительных функций

## Функциональность

### Сбор информации об окнах

- **Заголовок окна** (`title`)
- **Идентификатор приложения** (`app_id`)
- **Состояние окна**: активировано, свернуто, полноэкранный режим
- **Рабочая область** (workspace)
- **Фокус**: текущее активное окно
- **Размеры и положение** окна

### Классификация процессов

- Определение GUI vs CLI/daemon процессов
- Связывание окон с процессами
- Определение активных и фоновых приложений

### Интеграция с системой метрик

- Данные об окнах интегрируются с системой классификации
- Используются для определения приоритетов процессов
- Влияют на политики управления ресурсами

## Конфигурация

### Обнаружение композитора

```yaml
# В конфигурационном файле
window_introspection:
  wayland:
    enabled: true
    # Автоматическое обнаружение композитора
    auto_detect: true
    # Список поддерживаемых композиторов
    supported_compositors: ["mutter", "kwin", "sway", "hyprland", "wayfire", "river"]
```

### Ручная настройка

```yaml
window_introspection:
  wayland:
    enabled: true
    auto_detect: false
    # Ручное указание композитора
    compositor: "hyprland"
    # Дополнительные параметры для конкретного композитора
    hyprland:
      socket_path: "/tmp/hypr/.socket.sock"
      use_legacy_protocol: false
```

## Реализация

### WindowIntrospector

Основной компонент для работы с Wayland композиторами.

#### Функции

- `detect_wayland_compositor()`: Обнаружение текущего композитора
- `connect_to_compositor()`: Подключение к композитору
- `get_windows()`: Получение списка окон
- `get_focused_window()`: Получение текущего активного окна
- `get_workspaces()`: Получение информации о рабочих областях

#### Пример использования

```rust
use smoothtask_core::metrics::windows_wayland::WindowIntrospector;

let mut introspector = WindowIntrospector::new();

// Обнаружение композитора
let compositor = introspector.detect_wayland_compositor()?;

// Подключение к композитору
introspector.connect_to_compositor(&compositor)?;

// Получение списка окон
let windows = introspector.get_windows()?;

// Получение активного окна
let focused_window = introspector.get_focused_window()?;
```

### Поддержка Wayfire

Новая поддержка Wayfire композитора включает:

- **Обнаружение**: Автоматическое обнаружение Wayfire через проверку переменных окружения
- **Подключение**: Использование стандартных Wayland протоколов
- **Обработка ошибок**: Улучшенная обработка ошибок с учетом специфики Wayfire
- **Тестирование**: Comprehensive тесты для Wayfire

#### Пример обнаружения Wayfire

```rust
fn detect_wayfire() -> bool {
    // Проверка переменной окружения WAYLAND_DISPLAY
    if let Ok(wayland_display) = std::env::var("WAYLAND_DISPLAY") {
        // Проверка переменной окружения XDG_CURRENT_DESKTOP
        if let Ok(desktop) = std::env::var("XDG_CURRENT_DESKTOP") {
            if desktop.to_lowercase().contains("wayfire") {
                return true;
            }
        }
        
        // Проверка через wayland-info
        if let Ok(output) = std::process::Command::new("wayland-info")
            .arg("--show-compositor")
            .output()
        {
            if String::from_utf8_lossy(&output.stdout).contains("wayfire") {
                return true;
            }
        }
    }
    false
}
```

## Устранение неполадок

### Общие проблемы

1. **Ошибки подключения**:
   - Проверьте, что переменная окружения `WAYLAND_DISPLAY` установлена
   - Убедитесь, что демон имеет права на доступ к Wayland сокету
   - Проверьте, что композитор запущен

2. **Ошибки обнаружения**:
   - Проверьте, что переменная окружения `XDG_CURRENT_DESKTOP` установлена
   - Убедитесь, что композитор поддерживается SmoothTask
   - Проверьте, что утилиты `wayland-info` доступны

3. **Ошибки получения данных**:
   - Проверьте, что композитор поддерживает необходимые протоколы
   - Убедитесь, что у демона есть права на доступ к данным
   - Проверьте, что Wayland сессия активна

### Специфичные проблемы Wayfire

1. **Ошибки обнаружения**:
   - Убедитесь, что Wayfire правильно установлен и запущен
   - Проверьте, что переменные окружения установлены правильно
   - Попробуйте использовать `wayland-info --show-compositor` для диагностики

2. **Ошибки подключения**:
   - Проверьте, что Wayfire сокет доступен
   - Убедитесь, что демон имеет права на доступ к сокету
   - Проверьте, что Wayfire поддерживает необходимые протоколы

### Диагностические команды

```bash
# Проверка Wayland сессии
echo $WAYLAND_DISPLAY
echo $XDG_CURRENT_DESKTOP

# Проверка композитора
wayland-info --show-compositor

# Проверка доступных протоколов
wayland-info --show-protocols

# Проверка прав доступа
ls -la /tmp/wayland-*
```

## Интеграция с системой

### Интеграция с основным циклом демона

```rust
// В основном цикле демона
let mut introspector = WindowIntrospector::new();

// Обнаружение и подключение к композитору
if let Ok(compositor) = introspector.detect_wayland_compositor() {
    if let Ok(_) = introspector.connect_to_compositor(&compositor) {
        // Получение данных об окнах
        if let Ok(windows) = introspector.get_windows() {
            // Интеграция с системой классификации
            classifier.update_window_info(&windows);
        }
    }
}
```

### Интеграция с системой классификации

```rust
// В системе классификации
let window_info = introspector.get_windows()?;

for window in window_info {
    // Связывание окон с процессами
    if let Some(process) = process_manager.get_process_by_app_id(&window.app_id) {
        process.set_has_window(true);
        process.set_window_state(window.state);
        
        if window.is_focused {
            process.set_is_focused(true);
        }
    }
}
```

## Тестирование

### Тесты для Wayfire

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use crate::metrics::windows_wayland::detect_wayfire;
    
    #[test]
    fn test_wayfire_detection() {
        // Тест обнаружения Wayfire
        let is_wayfire = detect_wayfire();
        
        // В зависимости от окружения, тест может пройти или нет
        // Это нормально, так как Wayfire может не быть установлен
        if is_wayfire {
            println!("Wayfire detected successfully");
        } else {
            println!("Wayfire not detected (may not be running)");
        }
    }
    
    #[test]
    fn test_compositor_detection() {
        // Тест обнаружения композитора
        let mut introspector = WindowIntrospector::new();
        let result = introspector.detect_wayland_compositor();
        
        match result {
            Ok(compositor) => println!("Detected compositor: {}", compositor),
            Err(e) => println!("No Wayland compositor detected: {}", e),
        }
    }
}
```

### Ручное тестирование

1. **Проверка обнаружения**:
   ```bash
   # Запуск демона с отладочным выводом
   RUST_LOG=debug cargo run --bin smoothtaskd
   
   # Проверка обнаружения композитора
   journalctl -u smoothtaskd -f | grep "Wayland\|compositor"
   ```

2. **Проверка получения данных**:
   ```bash
   # Проверка API для получения данных об окнах
   curl http://localhost:8080/api/windows
   
   # Проверка логов на наличие данных об окнах
   grep "window\|focus" /var/log/smoothtask/app.log
   ```

## Производительность и оптимизация

### Оптимизация для Wayland

- **Кэширование данных**: Кэширование данных об окнах для уменьшения накладных расходов
- **Минимальные запросы**: Запрос только необходимых данных
- **Асинхронная обработка**: Использование асинхронных операций для минимизации блокировок
- **Оптимизированные протоколы**: Использование наиболее эффективных протоколов для каждого композитора

### Рекомендации по настройке

#### Для производственных систем

- **Кэширование**: Включить кэширование данных об окнах
- **Интервал опроса**: 1-5 секунд для баланса между актуальностью и производительностью
- **Тайм-ауты**: Установить разумные тайм-ауты для подключения и запросов

#### Для систем с высокой нагрузкой

- **Интервал опроса**: 5-10 секунд для уменьшения накладных расходов
- **Кэширование**: Увеличить время жизни кэша
- **Оптимизированные протоколы**: Использовать наиболее эффективные протоколы

#### Для систем с ограниченными ресурсами

- **Интервал опроса**: 10-30 секунд для минимального использования ресурсов
- **Кэширование**: Максимальное время жизни кэша
- **Минимальные данные**: Запрашивать только наиболее критичные данные

## Будущие улучшения

### Планируемые функции

- **Расширенная поддержка протоколов**: Добавление поддержки новых протоколов
- **Улучшенная интеграция**: Более тесная интеграция с системами классификации
- **Автоматическая настройка**: Автоматическая настройка параметров для каждого композитора
- **Расширенная диагностика**: Улучшенные инструменты диагностики и мониторинга

### Планируемые композиторы

- **Weston**: Базовый референсный композитор
- **Enlightenment**: Продвинутый композитор с расширенными функциями
- **Cage**: Минималистичный композитор для встраиваемых систем
- **Hikari**: Композитор для планшетов и сенсорных устройств

## Заключение

Поддержка Wayland композиторов в SmoothTask предоставляет мощные возможности для мониторинга окон и приложений. Система поддерживает широкий спектр композиторов и предоставляет гибкие возможности для настройки и интеграции. С улучшенной обработкой ошибок и comprehensive тестами, система обеспечивает надежную работу в различных окружениях.