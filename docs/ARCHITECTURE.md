# Архитектура SmoothTask

## Обзор

SmoothTask состоит из двух основных компонентов:

1. **Rust-демон** (`smoothtaskd`) — системный демон, работающий в реальном времени
2. **Python-тренер** (`smoothtask-trainer`) — инструменты для офлайн-обучения ML-моделей

## Компоненты Rust-демона

### Metrics Collector
- Сбор глобальных метрик из `/proc`, PSI
- Per-process метрики (CPU, IO, память)
- Информация о вводе пользователя (evdev)
- Состояние окон и фокуса (X11/Wayland)
- Метрики аудио (PipeWire/PulseAudio, XRUN)

### Process Grouper
- Построение AppGroup (групп процессов одного приложения)
- Определение корневого процесса и потомков

### Process Classifier
- Классификация процессов по типам (GUI/CLI/daemon/batch/...)
- Использование паттерн-базы приложений
- Определение тегов (browser/ide/game/audio/...)

### Policy Engine
- Жёсткие правила (guardrails)
- Семантические правила
- Интеграция с ML-ранкером (опционально)
- Определение целевого класса приоритета

### Actuator
- Применение приоритетов через `nice`, `latency_nice`, `ionice`
- Управление cgroups v2 (cpu.weight, cpu.max, IO-лимиты)
- Гистерезис для предотвращения частых изменений

### Snapshot Logger
- Сохранение снапшотов в SQLite
- Формирование датасета для обучения

## Компоненты Python-тренера

### Data Preparator
- Чтение снапшотов из SQLite
- Формирование датасета для CatBoostRanker

### CatBoost Trainer
- Обучение CatBoostRanker на собранных снапшотах
- Валидация и экспорт моделей (ONNX, JSON)

### Policy Tuner
- Оффлайн-оптимизация параметров политики
- Тюнинг порогов по метрикам отзывчивости

## Модель данных

См. раздел 4 в [tz.md](tz.md) для подробного описания структур данных:
- `Snapshot`
- `GlobalMetrics`
- `ProcessRecord`
- `AppGroupRecord`
- `ResponsivenessMetrics`

## Поток данных

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                            SmoothTask Architecture                             │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐    ┌───────────┐  │
│  │             │    │             │    │                 │    │           │  │
│  │ Metrics     │───▶│ Process     │───▶│ Process         │───▶│ Policy    │  │
│  │ Collector   │    │ Grouper     │    │ Classifier      │    │ Engine    │  │
│  │             │    │             │    │                 │    │           │  │
│  └─────────────┘    └─────────────┘    └─────────────────┘    └───────────┘  │
│          ▲                                                                     │  │
│          │                                                                     │  │
│  ┌───────┴───────┐                                                          │  │
│  │               │                                                          │  │
│  │ System Metrics │                                                          │  │
│  │ (/proc, PSI,  │                                                          │  │
│  │  eBPF, etc.)  │                                                          │  │
│  │               │                                                          │  │
│  └───────────────┘                                                          │  │
│                                                                               │  │
│  ┌─────────────┐    ┌─────────────┐                                            │  │
│  │             │    │             │                                            │  │
│  │ Actuator    │◀───│ Policy     │                                            │  │
│  │             │    │ Decisions   │                                            │  │
│  │             │    │             │                                            │  │
│  └─────────────┘    └─────────────┘                                            │  │
│          ▼                                                                     │  │
│  ┌───────┴───────┐                                                          │  │
│  │               │                                                          │  │
│  │ System         │                                                          │  │
│  │ (cgroups,     │                                                          │  │
│  │  nice, etc.)  │                                                          │  │
│  │               │                                                          │  │
│  └───────────────┘                                                          │  │
│                                                                               │  │
│  ┌─────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                         │  │
│  │                          Snapshot Logger (Optional)                     │  │
│  │                                                                         │  │
│  └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                               │  │
└───────────────────────────────────────────────────────────────────────────────┘
```

## Детальное описание компонентов

### Metrics Collector

**Ответственность:** Сбор системных метрик в реальном времени

**Источники данных:**
- `/proc` файловая система (CPU, память, процессы)
- PSI (Pressure Stall Information) для мониторинга ресурсных ограничений
- eBPF программы для детализированного мониторинга:
  - Процессор (температура, использование по ядрам)
  - Процессы (CPU, память, диск, сеть, энергия)
  - Сетевые соединения и трафик
- Evdev для метрик ввода пользователя
- X11/Wayland для информации об окнах и фокусе
- PipeWire/PulseAudio для аудио метрик

**Выходные данные:**
- `GlobalMetrics` - глобальное состояние системы
- `ProcessRecord` - метрики для каждого процесса
- `AppGroupRecord` - агрегированные метрики для групп процессов

### Process Grouper

**Ответственность:** Группировка связанных процессов в логические приложения

**Алгоритмы:**
- Анализ дерева процессов (родительские/дочерние отношения)
- Группировка по сессиям и терминалам
- Обнаружение корневых процессов приложений
- Объединение процессов с общими ресурсами

**Выходные данные:**
- `AppGroup` - группа процессов, принадлежащих одному приложению
- Иерархия процессов с корневым процессом

### Process Classifier

**Ответственность:** Классификация процессов по типам и назначению

**Методы классификации:**
- **Паттерн-база:** Предопределенные правила для известных приложений
- **Эвристический анализ:** Анализ имен процессов, аргументов, ресурсов
- **Поведенческий анализ:** Мониторинг использования ресурсов и взаимодействия

**Классификации:**
- **Типы процессов:** GUI, CLI, daemon, batch, service
- **Теги приложений:** browser, ide, game, audio, video, build_tool
- **Классы QoS:** LATENCY_CRITICAL, INTERACTIVE, BACKGROUND, IDLE

### Policy Engine

**Ответственность:** Определение оптимальных приоритетов для процессов

**Компоненты:**
- **Guardrails:** Жесткие правила безопасности и ограничений
- **Семантические правила:** Правила на основе типов и тегов процессов
- **ML Ranker (опционально):** Машинное обучение для динамической оптимизации
- **Контекстный анализ:** Учет текущего состояния системы

**Входные данные:**
- Текущие метрики системы и процессов
- Классификация и теги процессов
- Текущие приоритеты и ограничения

**Выходные данные:**
- Целевые классы приоритетов для каждого процесса
- Рекомендации по ресурсным ограничениям

### Actuator

**Ответственность:** Применение решений политики к системе

**Механизмы управления:**
- **CPU приоритеты:** `nice`, `latency_nice`, `sched_setattr`
- **IO приоритеты:** `ionice`
- **Ресурсные ограничения:** cgroups v2 (cpu.weight, cpu.max, memory.high, io.max)
- **Гистерезис:** Предотвращение частых изменений приоритетов

**Безопасность:**
- Проверка прав доступа перед применением изменений
- Логирование всех изменений для аудита
- Graceful degradation при отсутствии прав

### Snapshot Logger

**Ответственность:** Сохранение состояния системы для анализа и обучения

**Функции:**
- Периодическое сохранение снапшотов в SQLite
- Ротация логов для управления размером
- Экспорт данных для оффлайн-анализа
- Анонимизация чувствительных данных

**Использование:**
- Обучение ML-моделей
- Анализ производительности
- Отладка и диагностика

## Взаимодействие с Python-тренером

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                     Offline Training Pipeline                                 │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │             │    │                 │    │                 │              │
│  │ Data        │───▶│ CatBoost       │───▶│ Model           │              │
│  │ Preparator  │    │ Trainer        │    │ Exporter        │              │
│  │             │    │                 │    │                 │              │
│  └─────────────┘    └─────────────────┘    └─────────────────┘              │
│       ▲                                                                     │              │
│       │                                                                     │              │
│  ┌────┴───────┐                                                             │              │
│  │            │                                                             │              │
│  │ SQLite     │                                                             │              │
│  │ Snapshots  │                                                             │              │
│  │            │                                                             │              │
│  └────────────┘                                                             │              │
│                                                                               │              │
│  ┌─────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                         │  │
│  │                          Policy Tuner (Optional)                        │  │
│  │                                                                         │  │
│  └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                               │              │
└───────────────────────────────────────────────────────────────────────────────┘
```

### Data Preparator

**Ответственность:** Подготовка данных для обучения ML-моделей

**Функции:**
- Чтение и агрегация снапшотов из SQLite
- Feature engineering и нормализация
- Разделение на обучающую/валидационную выборки
- Генерация таргетов для ранкинга

### CatBoost Trainer

**Ответственность:** Обучение моделей ранкинга

**Процесс:**
- Обучение CatBoostRanker на исторических данных
- Кросс-валидация и оценка качества
- Оптимизация гиперпараметров
- Экспорт моделей в ONNX и JSON форматы

### Policy Tuner

**Ответственность:** Оптимизация параметров политики

**Методы:**
- Анализ исторических данных о производительности
- Оптимизация порогов и весов правил
- Тестирование различных стратегий управления
- Генерация рекомендаций по конфигурации

## Производительность и масштабируемость

### Оптимизации производительности

- **Кэширование:** Кэширование метрик для уменьшения нагрузки на систему
- **Батчинг:** Групповое применение изменений приоритетов
- **Асинхронность:** Использование tokio для параллельной обработки
- **Минимальные привилегии:** Работа с минимально необходимыми правами

### Масштабируемость

- **Горизонтальное масштабирование:** Поддержка нескольких демонов на одном хосте
- **Вертикальное масштабирование:** Оптимизация для систем с большим количеством ядер
- **Адаптивность:** Динамическая настройка частоты опроса в зависимости от нагрузки

## Безопасность и надежность

### Безопасность

- **Минимальные привилегии:** Работа с минимально необходимыми правами
- **Проверка входных данных:** Валидация всех внешних данных
- **Безопасное применение политик:** Проверка перед применением изменений
- **Аудит:** Логирование всех критичных операций

### Надежность

- **Graceful degradation:** Продолжение работы при частичных сбоях
- **Обработка ошибок:** Детальные сообщения об ошибках для диагностики
- **Восстановление:** Автоматическое восстановление после сбоев
- **Мониторинг:** Встроенный мониторинг состояния демона

