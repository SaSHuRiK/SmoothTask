# Архитектура SmoothTask

## Обзор

SmoothTask состоит из двух основных компонентов:

1. **Rust-демон** (`smoothtaskd`) — системный демон, работающий в реальном времени
2. **Python-тренер** (`smoothtask-trainer`) — инструменты для офлайн-обучения ML-моделей

## Компоненты Rust-демона

### Metrics Collector
- Сбор глобальных метрик из `/proc`, PSI
- Per-process метрики (CPU, IO, память)
- Информация о вводе пользователя (evdev)
- Состояние окон и фокуса (X11/Wayland)
- Метрики аудио (PipeWire/PulseAudio, XRUN)
- Мониторинг GPU через NVML и AMDGPU
- Мониторинг виртуальных машин
- Мониторинг контейнеров (Docker, Kubernetes, CRI-O, Rkt)
- Пользовательские метрики (файлы, команды, HTTP API, статические значения)
- **Расширенный мониторинг аппаратных устройств:**
  - Мониторинг PCI устройств (идентификация, температура, потребление мощности)
  - Мониторинг USB устройств (скорость, потребление мощности, температура)
  - Мониторинг устройств хранения (SATA/NVMe, температура, состояние здоровья, производительность)
  - **Мониторинг Thunderbolt устройств** (идентификация, производительность, классификация)
- **Расширенные системные метрики:**
  - Мониторинг системных вызовов (количество, частота, ошибки)
  - Мониторинг использования inode (общее количество, свободные, использованные)
  - Расширенный мониторинг swap (страницы в/из, активность)
  - **Мониторинг производительности системы** (CPU, память, ввод-вывод, сеть)

### Process Grouper
- Построение AppGroup (групп процессов одного приложения)
- Определение корневого процесса и потомков

### Process Classifier
- Классификация процессов по типам (GUI/CLI/daemon/batch/...)
- Использование паттерн-базы приложений
- Определение тегов (browser/ide/game/audio/...)
- ML-классификация с использованием CatBoost
- Кэширование фич для оптимизации производительности

### Policy Engine
- Жёсткие правила (guardrails)
- Семантические правила
- Интеграция с ML-ранкером (опционально)
- Определение целевого класса приоритета
- Поддержка пользовательских метрик в правилах

### Security Monitor
- **Мониторинг безопасности процессов**
- **Обнаружение подозрительных паттернов поведения**
- **Анализ аномального использования ресурсов**
- **Управление событиями безопасности**
- **Интеграция с системой уведомлений**
- **Расширенные возможности обнаружения угроз:**
  - Обнаружение подозрительных процессов
  - Анализ аномалий в использовании ресурсов
  - Обнаружение подозрительных паттернов поведения
  - Классификация событий безопасности по типам и уровням серьезности
  - Управление статусами событий безопасности

### Actuator
- Применение приоритетов через `nice`, `latency_nice`, `ionice`
- Управление cgroups v2 (cpu.weight, cpu.max, IO-лимиты)
- Гистерезис для предотвращения частых изменений

### Snapshot Logger
- Сохранение снапшотов в SQLite
- Формирование датасета для обучения

### Log Storage & Rotation
- Хранение логов в памяти с ротацией
- Автоматическая очистка по времени и памяти
- Поддержка memory-aware ротации
- Интеграция с системой мониторинга
- Статистика логов и динамическая настройка емкости

### Custom Metrics Manager
- Управление пользовательскими метриками
- Поддержка различных источников данных
- Автоматическое обновление по расписанию
- API для управления метриками

## Компоненты Python-тренера

### Data Preparator
- Чтение снапшотов из SQLite
- Формирование датасета для CatBoostRanker

### CatBoost Trainer
- Обучение CatBoostRanker на собранных снапшотах
- Валидация и экспорт моделей (ONNX, JSON)

### Policy Tuner
- Оффлайн-оптимизация параметров политики
- Тюнинг порогов по метрикам отзывчивости

## Модель данных

См. раздел 4 в [tz.md](tz.md) для подробного описания структур данных:
- `Snapshot`
- `GlobalMetrics`
- `ProcessRecord`
- `AppGroupRecord`
- `ResponsivenessMetrics`

### Новые структуры данных для аппаратного мониторинга

#### Аппаратные метрики
- `PciDeviceMetrics`: Информация о PCI устройствах (ID, вендор, класс, температура, мощность)
- `UsbDeviceMetrics`: Информация о USB устройствах (ID, вендор, продукт, скорость, мощность)
- `StorageDeviceMetrics`: Информация о устройствах хранения (модель, серийный номер, температура, здоровье)

#### Расширенные системные метрики
- `SystemCallMetrics`: Статистика системных вызовов (общее количество, ошибки, время)
- `InodeMetrics`: Использование inode (общее, свободные, использованные)
- `SwapMetrics`: Расширенная информация о swap (страницы в/из, активность)

## Поток данных

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                            SmoothTask Architecture                             │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐    ┌───────────┐  │
│  │             │    │             │    │                 │    │           │  │
│  │ Metrics     │───▶│ Process     │───▶│ Process         │───▶│ Policy    │  │
│  │ Collector   │    │ Grouper     │    │ Classifier      │    │ Engine    │  │
│  │             │    │             │    │                 │    │           │  │
│  └─────────────┘    └─────────────┘    └─────────────────┘    └───────────┘  │
│          ▲                                                                     │  │
│          │                                                                     │  │
│  ┌───────┴───────┐                                                          │  │
│  │               │                                                          │  │
│  │ System Metrics │                                                          │  │
│  │ (/proc, PSI,  │                                                          │  │
│  │  eBPF, etc.)  │                                                          │  │
│  │               │                                                          │  │
│  └───────────────┘                                                          │  │
│                                                                               │  │
│  ┌─────────────┐    ┌─────────────┐                                            │  │
│  │             │    │             │                                            │  │
│  │ Actuator    │◀───│ Policy     │                                            │  │
│  │             │    │ Decisions   │                                            │  │
│  │             │    │             │                                            │  │
│  └─────────────┘    └─────────────┘                                            │  │
│          ▼                                                                     │  │
│  ┌───────┴───────┐                                                          │  │
│  │               │                                                          │  │
│  │ System         │                                                          │  │
│  │ (cgroups,     │                                                          │  │
│  │  nice, etc.)  │                                                          │  │
│  │               │                                                          │  │
│  └───────────────┘                                                          │  │
│                                                                               │  │
│  ┌─────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                         │  │
│  │                          Snapshot Logger (Optional)                     │  │
│  │                                                                         │  │
│  └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                               │  │
└───────────────────────────────────────────────────────────────────────────────┘
```

## Детальное описание компонентов

### Metrics Collector

**Ответственность:** Сбор системных метрик в реальном времени

**Источники данных:**
- `/proc` файловая система (CPU, память, процессы)
- PSI (Pressure Stall Information) для мониторинга ресурсных ограничений
- eBPF программы для детализированного мониторинга:
  - Процессор (температура, использование по ядрам)
  - Процессы (CPU, память, диск, сеть, энергия)
  - Сетевые соединения и трафик
- Evdev для метрик ввода пользователя
- X11/Wayland для информации об окнах и фокусе
- PipeWire/PulseAudio для аудио метрик

**Выходные данные:**
- `GlobalMetrics` - глобальное состояние системы
- `ProcessRecord` - метрики для каждого процесса
- `AppGroupRecord` - агрегированные метрики для групп процессов

### eBPF Monitoring System

**Ответственность:** Детализированный мониторинг системы и процессов с использованием eBPF технологий

**Компоненты eBPF:**

#### 1. CPU Metrics Monitor
- **Функции:** Мониторинг температуры CPU, использования по ядрам, тактовой частоты
- **eBPF программы:** `cpu_metrics.c`, `cpu_temperature.c`
- **Метрики:** Температура ядер, частота, загрузка, тепловые ограничения
- **Требования:** Ядро Linux 5.4+, права CAP_BPF

#### 2. Process Metrics Monitor
- **Функции:** Детализированный мониторинг ресурсов процессов
- **eBPF программы:**
  - `process_memory.c` - мониторинг использования памяти
  - `process_gpu.c` - мониторинг использования GPU
  - `process_energy.c` - мониторинг энергопотребления
  - `process_disk.c` - мониторинг операций с диском
  - `process_network.c` - мониторинг сетевой активности
- **Метрики:**
  - Память: RSS, VMS, shared, swap, heap, stack
  - GPU: время использования, память, вычислительные единицы
  - Энергия: потребление в микроджоулях, мощность в микроваттах
  - Диск: операции чтения/записи, байты, задержки
  - Сеть: пакеты, байты, соединения

#### 3. Network Monitor
- **Функции:** Мониторинг сетевых соединений и трафика
- **eBPF программы:** `network_monitor.c`, `network_connections.c`
- **Метрики:**
  - Активные соединения (TCP/UDP)
  - Статистика трафика (пакеты, байты)
  - Состояние соединений
  - Порты и протоколы
- **Особенности:**
  - Поддержка фильтрации по протоколам и портам
  - Оптимизированный режим для высоконагруженных систем
  - Ограничение на количество отслеживаемых соединений (2048)

#### 4. Filesystem Monitor
- **Функции:** Мониторинг операций с файловой системой
- **eBPF программы:** `filesystem_monitor.c`, `filesystem_monitor_high_perf.c`
- **Метрики:**
  - Операции чтения/записи
  - Задержки ввода-вывода
  - Использование кэша страниц
  - Ошибки файловой системы

#### 5. System Call Monitor
- **Функции:** Мониторинг системных вызовов для анализа поведения
- **eBPF программы:** `syscall_monitor.c`
- **Метрики:**
  - Частота системных вызовов
  - Задержки выполнения
  - Ошибки и отказы
  - Паттерны использования

**Архитектура eBPF:**

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                          eBPF Monitoring Architecture                          │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐    ┌───────────┐  │
│  │             │    │             │    │                 │    │           │  │
│  │ User Space  │───▶│ eBPF        │───▶│ Kernel         │───▶│ Hardware  │  │
│  │ (SmoothTask)│    │ Programs    │    │ (Linux Kernel)  │    │ (CPU/GPU/  │  │
│  │             │◀───│             │◀───│                 │◀───│ NIC/Disk)  │  │
│  └─────────────┘    └─────────────┘    └─────────────────┘    └───────────┘  │
│          ▲                                                                     │  │
│          │                                                                     │  │
│  ┌───────┴───────┐                                                          │  │
│  │               │                                                          │  │
│  │ eBPF Maps      │                                                          │  │
│  │ (Data Storage) │                                                          │  │
│  │               │                                                          │  │
│  └───────────────┘                                                          │  │
│          ▲                                                                     │  │
│          │                                                                     │  │
│  ┌───────┴───────┐                                                          │  │
│  │               │                                                          │  │
│  │ Metrics        │                                                          │  │
│  │ Aggregation    │                                                          │  │
│  │               │                                                          │  │
│  └───────────────┘                                                          │  │
│                                                                               │  │
└───────────────────────────────────────────────────────────────────────────────┘
```

**Особенности eBPF мониторинга:**

1. **Безопасность и изоляция:**
   - eBPF программы выполняются в изолированном окружении
   - Верификация байт-кода перед загрузкой
   - Ограниченный доступ к системным ресурсам

2. **Производительность:**
   - Минимальные накладные расходы на мониторинг
   - Оптимизированные программы для критических путей
   - Возможность динамической загрузки/выгрузки

3. **Гибкость:**
   - Динамическая компиляция программ при первом запуске
   - Конфигурируемые параметры мониторинга
   - Поддержка различных режимов (нормальный, высокопроизводительный)

4. **Ограничения:**
   - Требуется ядро Linux 5.4 или новее
   - Ограниченное количество отслеживаемых объектов
   - Сложность отладки eBPF программ

**Конфигурация eBPF:**

```yaml
metrics:
  ebpf:
    enable_cpu_temperature_monitoring: true
    enable_process_memory_monitoring: true
    enable_process_gpu_monitoring: true
    enable_process_energy_monitoring: true
    enable_process_disk_monitoring: true
    enable_process_network_monitoring: true
    enable_network_connections: true
    enable_network_monitoring: true
    enable_filesystem_monitoring: true
    enable_high_performance_mode: true
    
    filter_config:
      enable_kernel_filtering: true
      active_connections_threshold: 10
      network_traffic_threshold: 1024
      enable_network_protocol_filtering: false
      filtered_network_protocols: [6, 17]  # TCP=6, UDP=17
```

### Process Grouper

**Ответственность:** Группировка связанных процессов в логические приложения

**Алгоритмы:**
- Анализ дерева процессов (родительские/дочерние отношения)
- Группировка по сессиям и терминалам
- Обнаружение корневых процессов приложений
- Объединение процессов с общими ресурсами

**Выходные данные:**
- `AppGroup` - группа процессов, принадлежащих одному приложению
- Иерархия процессов с корневым процессом

### Process Classifier

**Ответственность:** Классификация процессов по типам и назначению

**Методы классификации:**
- **Паттерн-база:** Предопределенные правила для известных приложений
- **Эвристический анализ:** Анализ имен процессов, аргументов, ресурсов
- **Поведенческий анализ:** Мониторинг использования ресурсов и взаимодействия

**Классификации:**
- **Типы процессов:** GUI, CLI, daemon, batch, service
- **Теги приложений:** browser, ide, game, audio, video, build_tool
- **Классы QoS:** LATENCY_CRITICAL, INTERACTIVE, BACKGROUND, IDLE

### Policy Engine

**Ответственность:** Определение оптимальных приоритетов для процессов

**Компоненты:**
- **Guardrails:** Жесткие правила безопасности и ограничений
- **Семантические правила:** Правила на основе типов и тегов процессов
- **ML Ranker (опционально):** Машинное обучение для динамической оптимизации
- **Контекстный анализ:** Учет текущего состояния системы

**Входные данные:**
- Текущие метрики системы и процессов
- Классификация и теги процессов
- Текущие приоритеты и ограничения

**Выходные данные:**
- Целевые классы приоритетов для каждого процесса
- Рекомендации по ресурсным ограничениям

### Actuator

**Ответственность:** Применение решений политики к системе

**Механизмы управления:**
- **CPU приоритеты:** `nice`, `latency_nice`, `sched_setattr`
- **IO приоритеты:** `ionice`
- **Ресурсные ограничения:** cgroups v2 (cpu.weight, cpu.max, memory.high, io.max)
- **Гистерезис:** Предотвращение частых изменений приоритетов

**Безопасность:**
- Проверка прав доступа перед применением изменений
- Логирование всех изменений для аудита
- Graceful degradation при отсутствии прав

### Snapshot Logger

**Ответственность:** Сохранение состояния системы для анализа и обучения

**Функции:**
- Периодическое сохранение снапшотов в SQLite
- Ротация логов для управления размером
- Экспорт данных для оффлайн-анализа
- Анонимизация чувствительных данных

**Использование:**
- Обучение ML-моделей
- Анализ производительности
- Отладка и диагностика

## Взаимодействие с Python-тренером

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                     Offline Training Pipeline                                 │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │             │    │                 │    │                 │              │
│  │ Data        │───▶│ CatBoost       │───▶│ Model           │              │
│  │ Preparator  │    │ Trainer        │    │ Exporter        │              │
│  │             │    │                 │    │                 │              │
│  └─────────────┘    └─────────────────┘    └─────────────────┘              │
│       ▲                                                                     │              │
│       │                                                                     │              │
│  ┌────┴───────┐                                                             │              │
│  │            │                                                             │              │
│  │ SQLite     │                                                             │              │
│  │ Snapshots  │                                                             │              │
│  │            │                                                             │              │
│  └────────────┘                                                             │              │
│                                                                               │              │
│  ┌─────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                         │  │
│  │                          Policy Tuner (Optional)                        │  │
│  │                                                                         │  │
│  └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                               │              │
└───────────────────────────────────────────────────────────────────────────────┘
```

### Data Preparator

**Ответственность:** Подготовка данных для обучения ML-моделей

**Функции:**
- Чтение и агрегация снапшотов из SQLite
- Feature engineering и нормализация
- Разделение на обучающую/валидационную выборки
- Генерация таргетов для ранкинга

### CatBoost Trainer

**Ответственность:** Обучение моделей ранкинга

**Процесс:**
- Обучение CatBoostRanker на исторических данных
- Кросс-валидация и оценка качества
- Оптимизация гиперпараметров
- Экспорт моделей в ONNX и JSON форматы

### Policy Tuner

**Ответственность:** Оптимизация параметров политики

**Методы:**
- Анализ исторических данных о производительности
- Оптимизация порогов и весов правил
- Тестирование различных стратегий управления
- Генерация рекомендаций по конфигурации

## Производительность и масштабируемость

### Оптимизации производительности

- **Кэширование:** Кэширование метрик для уменьшения нагрузки на систему
- **Батчинг:** Групповое применение изменений приоритетов
- **Асинхронность:** Использование tokio для параллельной обработки
- **Минимальные привилегии:** Работа с минимально необходимыми правами

### Масштабируемость

- **Горизонтальное масштабирование:** Поддержка нескольких демонов на одном хосте
- **Вертикальное масштабирование:** Оптимизация для систем с большим количеством ядер
- **Адаптивность:** Динамическая настройка частоты опроса в зависимости от нагрузки

## Обработка ошибок и надежность

### Стратегия обработки ошибок

SmoothTask использует многоуровневый подход к обработке ошибок для обеспечения надежности и отказоустойчивости:

#### 1. **Иерархия ошибок**

- **Критические ошибки:** Ошибки, требующие немедленного вмешательства (например, отсутствие прав доступа)
- **Восстанавливаемые ошибки:** Ошибки, которые можно обработать с graceful degradation (например, временная недоступность ресурса)
- **Информационные ошибки:** Ошибки, которые логируются, но не влияют на основную функциональность

#### 2. **Паттерны обработки ошибок**

**a) Использование `anyhow` для контекстных ошибок:**
```rust
use anyhow::{Context, Result};

fn read_config() -> Result<Config> {
    let content = std::fs::read("config.yml")
        .with_context(|| "Не удалось прочитать файл конфигурации")?;
    // ...
}
```

**b) Graceful degradation с fallback значениями:**
```rust
let current_nice = read_nice(pid).unwrap_or(0); // Fallback на 0 при ошибке
```

**c) Логирование и продолжение работы:**
```rust
if let Err(e) = apply_policy(pid, policy) {
    warn!("Не удалось применить политику к процессу {}: {}", pid, e);
    // Продолжаем работу с другими процессами
}
```

#### 3. **Лучшие практики обработки ошибок**

- **Контекстные сообщения:** Все ошибки должны содержать достаточно контекста для диагностики
- **Безопасные fallback:** Использовать `unwrap_or()` и `unwrap_or_else()` вместо `unwrap()`
- **Логирование:** Важные ошибки должны логироваться с соответствующим уровнем (error/warn)
- **Валидация входных данных:** Проверять все внешние данные перед использованием
- **Ресурсная безопасность:** Использовать RAII для управления ресурсами

### Примеры обработки ошибок в коде

#### Чтение системных метрик

```rust
pub fn read_cpu_times(path: &Path) -> Result<CpuTimes> {
    let content = std::fs::read_to_string(path)
        .with_context(|| format!("Не удалось прочитать CPU метрики из {:?}", path))?;
    
    parse_cpu_times(&content)
        .with_context(|| "Не удалось разобрать CPU метрики")
}
```

#### Применение приоритетов

```rust
fn apply_nice(pid: i32, nice: i32) -> Result<()> {
    if !(-20..=19).contains(&nice) {
        return Err(anyhow!("Nice значение {} вне допустимого диапазона [-20, 19]", nice));
    }
    
    unsafe {
        if libc::setpriority(libc::PRIO_PROCESS, pid, nice) != 0 {
            return Err(anyhow!("Не удалось установить nice {} для процесса {}: {}", 
                nice, pid, std::io::Error::last_os_error()));
        }
    }
    
    Ok(())
}
```

#### Обработка ошибок в API

```rust
async fn metrics_handler(State(state): State<ApiState>) -> Result<Json<Value>, StatusCode> {
    match collect_system_metrics() {
        Ok(metrics) => Ok(Json(json!(metrics))),
        Err(e) => {
            error!("Ошибка сбора метрик для API: {}", e);
            Err(StatusCode::INTERNAL_SERVER_ERROR)
        }
    }
}
```

### Надежность

- **Graceful degradation:** Продолжение работы при частичных сбоях
- **Обработка ошибок:** Детальные сообщения об ошибках для диагностики
- **Восстановление:** Автоматическое восстановление после сбоев
- **Мониторинг:** Встроенный мониторинг состояния демона

