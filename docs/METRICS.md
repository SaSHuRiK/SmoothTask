# Метрики SmoothTask

## Глобальные метрики

### CPU
- Процент использования CPU (user%, system%, idle%, iowait%)
- Источник: `/proc/stat`

### Memory
- Используемая и доступная память
- Используемый swap
- Источник: `/proc/meminfo`

### Load Average
- Средняя нагрузка системы
- Источник: `/proc/loadavg`

### PSI (Pressure Stall Information)
- `cpu_some_avg10`, `cpu_some_avg60` — давление на CPU
- `io_some_avg10` — давление на IO
- `mem_some_avg10`, `mem_full_avg10` — давление на память
- Источник: `/proc/pressure/{cpu,io,memory}`

### GPU
- Метрики использования, памяти, температуры, энергопотребления и тактовых частот для всех GPU устройств
- См. раздел "GPU метрики" ниже для подробностей

### Network
- Сетевые интерфейсы с метриками трафика (rx_bytes, tx_bytes, rx_packets, tx_packets, rx_errors, tx_errors)
- Общие метрики трафика (total_rx_bytes, total_tx_bytes)
- Источник: `/proc/net/dev`

### User Activity
- `user_active` (bool) — активен ли пользователь
- `time_since_last_input` — время с последнего ввода
- Источник: события evdev

## Per-process метрики

### Легкие метрики (для всех процессов)
- CPU usage (дельты за окно)
- Состояние процесса (R/S/D/Z/T)
- Приоритеты (nice, latency_nice, ionice)
- RSS
- Источник: `/proc/[pid]/stat`, `/proc/[pid]/sched`, `/proc/[pid]/io`

### Тяжелые метрики (только для кандидатов)
- Детальная информация о памяти (VmRSS, VmSwap)
- Контекстные переключения
- IO статистика (read_bytes, write_bytes)
- Переменные окружения
- Источники: `/proc/[pid]/status`, `/proc/[pid]/io`, `/proc/[pid]/environ`

## GPU метрики

### Общая информация
- Количество GPU устройств в системе
- Информация о каждом GPU устройстве (имя, путь, вендор ID, устройство ID, драйвер)
- Источники: `/sys/class/drm`, `/sys/class/drm/*/device`

### Метрики использования
- Процент использования GPU ядра (0.0 до 1.0)
- Процент использования GPU памяти (0.0 до 1.0)
- Процент использования GPU энкодера (опционально, 0.0 до 1.0)
- Процент использования GPU декодера (опционально, 0.0 до 1.0)
- Источники: `/sys/class/drm/*/device/gpu_busy_percent`, драйвер-специфичные интерфейсы

### Метрики памяти
- Общий объем GPU памяти в байтах
- Используемая GPU память в байтах
- Свободная GPU память в байтах
- Источники: `/sys/class/drm/*/device/mem_total_bytes`, `/sys/class/drm/*/device/mem_used_bytes`

### Температурные метрики
- Текущая температура CPU в Цельсиях (через eBPF или sysfs/hwmon)
- Максимальная температура CPU в Цельсиях (через eBPF)
- Текущая температура GPU в Цельсиях
- Температура горячей точки GPU в Цельсиях (опционально)
- Температура памяти GPU в Цельсиях (опционально)
- Источники: `/sys/class/drm/*/device/hwmon/*/temp*_input`, `/sys/class/hwmon/*/temp*_input`, `/sys/class/thermal/*/temp`, eBPF программы

**Примечание**: eBPF мониторинг температуры CPU предоставляет более точные и детализированные данные по каждому ядру, включая историю температур и критических событий.

### Метрики энергопотребления
- Текущее энергопотребление GPU в ваттах
- Лимит энергопотребления GPU в ваттах (опционально)
- Максимальное энергопотребление GPU в ваттах (опционально)
- Источники: `/sys/class/powercap/*/energy_uj`, `/sys/class/drm/*/device/hwmon/*/power*_input`

### Метрики тактовых частот
- Текущая частота GPU ядра в МГц
- Текущая частота GPU памяти в МГц (опционально)
- Текущая частота GPU шейдеров в МГц (опционально)
- Источники: `/sys/class/drm/*/device/gt_cur_freq_mhz`, драйвер-специфичные интерфейсы

## Сетевые метрики

### Общая информация
- Количество сетевых интерфейсов в системе
- Информация о каждом сетевом интерфейсе (имя, тип)
- Источник: `/proc/net/dev`

### Метрики трафика
- Полученные байты (rx_bytes) для каждого интерфейса
- Отправленные байты (tx_bytes) для каждого интерфейса
- Полученные пакеты (rx_packets) для каждого интерфейса
- Отправленные пакеты (tx_packets) для каждого интерфейса
- Ошибки приема (rx_errors) для каждого интерфейса
- Ошибки передачи (tx_errors) для каждого интерфейса
- Источник: `/proc/net/dev`

### Агрегированные метрики
- Общее количество полученных байт (total_rx_bytes) по всем интерфейсам
- Общее количество отправленных байт (total_tx_bytes) по всем интерфейсам
- Вычисляется как сумма метрик всех интерфейсов

### Пример структуры данных
```json
{
  "network": {
    "interfaces": [
      {
        "name": "eth0",
        "rx_bytes": 10000000,
        "tx_bytes": 20000000,
        "rx_packets": 10000,
        "tx_packets": 20000,
        "rx_errors": 1,
        "tx_errors": 2
      },
      {
        "name": "wlan0",
        "rx_bytes": 5000000,
        "tx_bytes": 15000000,
        "rx_packets": 5000,
        "tx_packets": 15000,
        "rx_errors": 0,
        "tx_errors": 0
      }
    ],
    "total_rx_bytes": 15000000,
    "total_tx_bytes": 35000000
  }
}
```

## Метрики отзывчивости

### Scheduling Latency
- P95 и P99 латентности планировщика
- Измеряется через probe-thread (mini-cyclictest)

### Аудио XRUN
- Количество XRUN событий в аудио-стеке
- Источник: PipeWire/PulseAudio

### UI Latency (опционально)
- P95 латентности event loop GUI
- Frame jank ratio

### Интегральный score
- `bad_responsiveness` — флаг плохой отзывчивости
- `responsiveness_score` — нормированная комбинация метрик

## Частота сбора

- Глобальные метрики: 500–1000 мс
- Per-process (легкие): 1–2 Гц для всех процессов
- Per-process (тяжелые): 500–1000 мс, только для топ-N кандидатов
- Ввод пользователя: в реальном времени через evdev
- Окна/фокус: синхронизировано с циклом метрик
- Аудио: синхронизировано с циклом метрик

