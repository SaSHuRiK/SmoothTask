# Метрики SmoothTask

## Глобальные метрики

### CPU
- Процент использования CPU (user%, system%, idle%, iowait%)
- Источник: `/proc/stat`

### Memory
- Используемая и доступная память
- Используемый swap
- Источник: `/proc/meminfo`

### Load Average
- Средняя нагрузка системы
- Источник: `/proc/loadavg`

### PSI (Pressure Stall Information)
- `cpu_some_avg10`, `cpu_some_avg60` — давление на CPU
- `io_some_avg10` — давление на IO
- `mem_some_avg10`, `mem_full_avg10` — давление на память
- Источник: `/proc/pressure/{cpu,io,memory}`

### GPU
- Метрики использования, памяти, температуры, энергопотребления и тактовых частот для всех GPU устройств
- См. раздел "GPU метрики" ниже для подробностей

### Network

#### Базовые сетевые метрики
- Сетевые интерфейсы с метриками трафика (rx_bytes, tx_bytes, rx_packets, tx_packets, rx_errors, tx_errors)
- Общие метрики трафика (total_rx_bytes, total_tx_bytes)
- Источник: `/proc/net/dev`

#### Комплексный мониторинг сети

**Метрики интерфейсов:**
- `name`: Имя интерфейса (например, "eth0", "wlan0")
- `interface_type`: Тип интерфейса (Ethernet, Wifi, Loopback, Virtual, Tunnel, Bridge, Unknown)
- `mac_address`: MAC адрес интерфейса (опционально)
- `ip_addresses`: Список IP адресов, назначенных интерфейсу
- `speed_mbps`: Скорость интерфейса в Мбит/с (опционально)
- `is_up`: Состояние интерфейса (включен/выключен)
- `rx_bytes`: Полученные байты
- `tx_bytes`: Переданные байты
- `rx_packets`: Полученные пакеты
- `tx_packets`: Переданные пакеты
- `rx_errors`: Ошибки приема
- `tx_errors`: Ошибки передачи
- `rx_dropped`: Утерянные принятые пакеты
- `tx_dropped`: Утерянные переданные пакеты
- `rx_overruns`: Переполнения приема
- `tx_overruns`: Переполнения передачи
- `flags`: Флаги интерфейса
- `timestamp`: Время последнего обновления
- Источники: `/proc/net/dev`, `/sys/class/net/*`

**Протокольные метрики:**
- `tcp_connections`: Количество TCP соединений
- `udp_connections`: Количество UDP соединений
- `icmp_packets`: Количество ICMP пакетов
- `tcp_retransmissions`: Количество TCP ретрансляций
- `tcp_errors`: Количество TCP ошибок
- `udp_errors`: Количество UDP ошибок
- Источник: `/proc/net/snmp`

**Метрики использования портов:**
- `port`: Номер порта
- `protocol`: Протокол (TCP/UDP)
- `connection_count`: Количество соединений на порту
- `bytes_transmitted`: Байты переданные через порт
- `bytes_received`: Байты полученные через порт
- `processes`: Список PID процессов, использующих порт
- Источник: eBPF или системные утилиты

**Метрики активных соединений:**
- `src_ip`: IP адрес источника
- `dst_ip`: IP адрес назначения
- `src_port`: Порт источника
- `dst_port`: Порт назначения
- `protocol`: Протокол (TCP/UDP)
- `state`: Состояние соединения
- `pid`: PID процесса (опционально)
- `process_name`: Имя процесса (опционально)
- `bytes_transmitted`: Переданные байты
- `bytes_received`: Полученные байты
- `packets_transmitted`: Переданные пакеты
- `packets_received`: Полученные пакеты
- `start_time`: Время начала соединения
- `last_activity`: Время последней активности
- `duration`: Продолжительность соединения
- Источник: eBPF или `/proc/net/tcp`, `/proc/net/udp`

**Метрики качества сети:**
- `packet_loss`: Процент потери пакетов (0.0 до 1.0)
- `latency_ms`: Задержка в миллисекундах
- `jitter_ms`: Джиттер в миллисекундах
- `bandwidth_utilization`: Использование пропускной способности (0.0 до 1.0)
- `stability_score`: Оценка стабильности сети (0.0 до 1.0)
- Источник: Активное тестирование сети (ping, traceroute и т.д.)

**Агрегированные метрики:**
- `total_rx_bytes`: Общее количество полученных байт по всем интерфейсам
- `total_tx_bytes`: Общее количество переданных байт по всем интерфейсам
- `total_rx_packets`: Общее количество полученных пакетов по всем интерфейсам
- `total_tx_packets`: Общее количество переданных пакетов по всем интерфейсам

#### Конфигурация сетевого мониторинга

Сетевой мониторинг настраивается через конфигурационный файл:

```yaml
network_monitoring:
  enable_detailed_interfaces: true    # Включить детализированный мониторинг интерфейсов
  enable_protocol_monitoring: true    # Включить мониторинг протоколов
  enable_port_monitoring: true        # Включить мониторинг портов
  enable_connection_tracking: true    # Включить отслеживание соединений
  enable_quality_monitoring: true    # Включить мониторинг качества сети
  max_connections: 1024              # Максимальное количество отслеживаемых соединений
  update_interval_secs: 60           # Интервал обновления метрик в секундах
  monitored_ports: [80, 443, 22, 53, 8080]  # Порты для специального мониторинга
  monitored_protocols: ["TCP", "UDP"]      # Протоколы для мониторинга
```

#### Примеры использования

1. **Мониторинг пропускной способности интерфейса:**
   ```json
   {
     "name": "eth0",
     "rx_bytes": 1073741824,
     "tx_bytes": 2147483648,
     "speed_mbps": 1000
   }
   ```

2. **Анализ протокольного трафика:**
   ```json
   {
     "tcp_connections": 150,
     "udp_connections": 75,
     "icmp_packets": 30,
     "tcp_retransmissions": 5
   }
   ```

3. **Оценка качества сети:**
   ```json
   {
     "packet_loss": 0.01,
     "latency_ms": 25.5,
     "stability_score": 0.98
   }
   ```

### User Activity
- `user_active` (bool) — активен ли пользователь
- `time_since_last_input` — время с последнего ввода
- Источник: события evdev

## Per-process метрики

### Легкие метрики (для всех процессов)
- CPU usage (дельты за окно)
- Состояние процесса (R/S/D/Z/T)
- Приоритеты (nice, latency_nice, ionice)
- RSS
- Источник: `/proc/[pid]/stat`, `/proc/[pid]/sched`, `/proc/[pid]/io`

### Тяжелые метрики (только для кандидатов)
- Детальная информация о памяти (VmRSS, VmSwap)
- Контекстные переключения
- IO статистика (read_bytes, write_bytes)
- Переменные окружения
- Источники: `/proc/[pid]/status`, `/proc/[pid]/io`, `/proc/[pid]/environ`

### Метрики энергопотребления процессов
- Энергопотребление процесса в микроджоулях (energy_uj)
- Текущая мощность процесса в ваттах (power_w)
- Временная метка сбора данных (energy_timestamp)
- Источники: `/proc/[pid]/power/energy_uj`, RAPL интерфейсы

**Подробности:**
- **RAPL (Running Average Power Limit)**: Технология Intel для мониторинга энергопотребления на уровне процессов
- **Фоллбэк механизмы**: Если RAPL недоступен, используются альтернативные источники
- **Точность**: Высокая точность измерений для оптимизации энергопотребления
- **Интеграция**: Данные интегрируются с системой классификации для оптимизации политик

## GPU метрики

### Общая информация
- Количество GPU устройств в системе
- Информация о каждом GPU устройстве (имя, путь, вендор ID, устройство ID, драйвер)
- Источники: `/sys/class/drm`, `/sys/class/drm/*/device`

### Метрики использования
- Процент использования GPU ядра (0.0 до 1.0)
- Процент использования GPU памяти (0.0 до 1.0)
- Процент использования GPU энкодера (опционально, 0.0 до 1.0)
- Процент использования GPU декодера (опционально, 0.0 до 1.0)
- Источники: `/sys/class/drm/*/device/gpu_busy_percent`, драйвер-специфичные интерфейсы

### Метрики памяти
- Общий объем GPU памяти в байтах
- Используемая GPU память в байтах
- Свободная GPU память в байтах
- Источники: `/sys/class/drm/*/device/mem_total_bytes`, `/sys/class/drm/*/device/mem_used_bytes`

### Температурные метрики
- Текущая температура CPU в Цельсиях (через eBPF или sysfs/hwmon)
- Максимальная температура CPU в Цельсиях (через eBPF)
- Текущая температура GPU в Цельсиях
- Температура горячей точки GPU в Цельсиях (опционально)
- Температура памяти GPU в Цельсиях (опционально)
- Источники: `/sys/class/drm/*/device/hwmon/*/temp*_input`, `/sys/class/hwmon/*/temp*_input`, `/sys/class/thermal/*/temp`, eBPF программы

**Примечание**: eBPF мониторинг температуры CPU предоставляет более точные и детализированные данные по каждому ядру, включая историю температур и критических событий.

### Метрики энергопотребления
- Текущее энергопотребление GPU в ваттах
- Лимит энергопотребления GPU в ваттах (опционально)
- Максимальное энергопотребление GPU в ваттах (опционально)
- Энергопотребление процессов на GPU (через RAPL и eBPF)
- Источники: `/sys/class/powercap/*/energy_uj`, `/sys/class/drm/*/device/hwmon/*/power*_input`, RAPL интерфейсы, eBPF программы

**Улучшения RAPL:**
- Добавлена поддержка RAPL (Running Average Power Limit) для мониторинга энергопотребления
- Улучшена функция `collect_process_energy_metrics` с несколькими источниками данных
- Улучшена интеграция с eBPF энергетическими метриками
- Улучшена обработка ошибок и логирование для энергетических метрик

### Метрики тактовых частот
- Текущая частота GPU ядра в МГц
- Текущая частота GPU памяти в МГц (опционально)
- Текущая частота GPU шейдеров в МГц (опционально)
- Источники: `/sys/class/drm/*/device/gt_cur_freq_mhz`, драйвер-специфичные интерфейсы

## Сетевые метрики

### Общая информация
- Количество сетевых интерфейсов в системе
- Информация о каждом сетевом интерфейсе (имя, тип)
- Источник: `/proc/net/dev`

### Метрики трафика
- Полученные байты (rx_bytes) для каждого интерфейса
- Отправленные байты (tx_bytes) для каждого интерфейса
- Полученные пакеты (rx_packets) для каждого интерфейса
- Отправленные пакеты (tx_packets) для каждого интерфейса
- Ошибки приема (rx_errors) для каждого интерфейса
- Ошибки передачи (tx_errors) для каждого интерфейса
- Источник: `/proc/net/dev`

### Агрегированные метрики
- Общее количество полученных байт (total_rx_bytes) по всем интерфейсам
- Общее количество отправленных байт (total_tx_bytes) по всем интерфейсам
- Вычисляется как сумма метрик всех интерфейсов

### Пример структуры данных
```json
{
  "network": {
    "interfaces": [
      {
        "name": "eth0",
        "rx_bytes": 10000000,
        "tx_bytes": 20000000,
        "rx_packets": 10000,
        "tx_packets": 20000,
        "rx_errors": 1,
        "tx_errors": 2
      },
      {
        "name": "wlan0",
        "rx_bytes": 5000000,
        "tx_bytes": 15000000,
        "rx_packets": 5000,
        "tx_packets": 15000,
        "rx_errors": 0,
        "tx_errors": 0
      }
    ],
    "total_rx_bytes": 15000000,
    "total_tx_bytes": 35000000
  }
}
```

## Метрики отзывчивости

### Scheduling Latency
- P95 и P99 латентности планировщика
- Измеряется через probe-thread (mini-cyclictest)

### Аудио XRUN
- Количество XRUN событий в аудио-стеке
- Источник: PipeWire/PulseAudio

### UI Latency (опционально)
- P95 латентности event loop GUI
- Frame jank ratio

### Интегральный score
- `bad_responsiveness` — флаг плохой отзывчивости
- `responsiveness_score` — нормированная комбинация метрик

## Частота сбора

- Глобальные метрики: 500–1000 мс
- Per-process (легкие): 1–2 Гц для всех процессов
- Per-process (тяжелые): 500–1000 мс, только для топ-N кандидатов
- Ввод пользователя: в реальном времени через evdev
- Окна/фокус: синхронизировано с циклом метрик
- Аудио: синхронизировано с циклом метрик

